<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<meta name="description" content="EnfermerÃ­a MAXI Â· Final Full â€” procedimientos, PAE, combinador fÃ¡rmacos, enfermedades, RCP, PWA."/>
<title>EnfermerÃ­a MAXI Â· Final Full</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: linear-gradient(135deg, #69f0ae 0%, #16a34a 100%);
    --glass: rgba(255,255,255,0.66);
    --glass-2: rgba(255,255,255,0.12);
    --accent:#16a34a;
    --accent-2:#06b6d4;
    --accent-3:#69f0ae;
    --muted:#4b5563;
    --danger:#dc2626;
    --card-radius:14px;
    --shadow:0 10px 32px rgba(6,95,70,0.12);
    --tap:48px;
    --font:'Roboto',system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    --maxwidth:1100px;
    --glass-border: 1.5px solid rgba(16,185,129,0.18);
  }
  :root[data-theme="dark"]{
    --bg: linear-gradient(135deg,#071014 0%,#071a12 100%);
    --glass: rgba(8,24,18,0.75);
    --glass-2: rgba(255,255,255,0.02);
    --muted:#dff6ea;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:var(--font);background:var(--bg);-webkit-font-smoothing:antialiased;
    display:flex;justify-content:center;padding:12px; color:#022;min-height:100vh;
    transition: background .7s, color .7s; /* animaciÃ³n de tema */
  }
  .app{width:100%;max-width:var(--maxwidth);margin:10px 0}
  header.appbar{display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:12px;background:var(--glass);box-shadow:var(--shadow);backdrop-filter:blur(12px);border:var(--glass-border);}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:54px;height:54px;border-radius:12px;display:grid;place-items:center;color:#fff;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:0 4px 14px rgba(6,182,212,.16);}
  .brand h1{font-size:1.05rem;margin:0}
  .brand p{margin:0;font-size:0.86rem;color:var(--muted)}
  .tools-right{display:flex;gap:8px;align-items:center}
  .clock{min-width:86px;text-align:center;padding:6px 8px;border-radius:10px;background:var(--glass-2);font-weight:700}
  .icon-btn{height:var(--tap);width:var(--tap);display:grid;place-items:center;border-radius:10px;border:0;background:transparent;cursor:pointer;transition:transform .16s;}
  .icon-btn:focus{outline:3px solid #06b6d455;outline-offset:3px;}
  .icon-btn:hover{transform:scale(1.12);background:rgba(6,182,212,0.11);}
  .fav-btn{font-size:1.2em;cursor:pointer;background:transparent;border:none;padding:0 6px;}
  .fav-btn:focus{outline:2px solid #06b6d4;}

  .shell{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
  @media(min-width:980px){ .shell{grid-template-columns:320px 1fr 380px} }

  nav.sidebar{background:var(--glass);padding:12px;border-radius:12px;box-shadow:var(--shadow);backdrop-filter:blur(12px);border:var(--glass-border);}
  .cat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .cat-btn{padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.6),rgba(255,255,255,0.3));border:1.5px solid rgba(16,185,129,0.10);font-weight:700;text-align:center;cursor:pointer;transition:background .18s,transform .18s;}
  .cat-btn.full{grid-column:1/-1}
  .cat-btn:hover{background:linear-gradient(90deg,#16a34a 0%,#06b6d4 100%);color:#fff;transform:scale(1.04);}
  .small{font-size:0.88rem;color:var(--muted)}

  main.panel{background:var(--glass);padding:12px;border-radius:12px;box-shadow:var(--shadow);backdrop-filter:blur(12px);border:var(--glass-border);}
  .search-row{display:flex;gap:8px}
  .input{flex:1;padding:12px;border-radius:10px;border:1.5px solid rgba(16,185,129,0.12);font-size:0.95rem;background:rgba(255,255,255,0.38);transition:border-color .2s,box-shadow .2s;}
  .input:focus{border-color:#06b6d4;box-shadow:0 0 0 2px #06b6d433;}
  .btn{padding:10px 12px;border-radius:10px;border:0;font-weight:700;cursor:pointer;transition:transform .16s;}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;box-shadow:0 2px 4px rgba(6,95,70,0.11);}
  .btn.ghost{background:transparent;border:1.5px solid rgba(16,185,129,0.16);}
  .btn.primary:hover, .btn.ghost:hover{transform:scale(1.04);filter:brightness(1.13);}
  .btn:focus{outline:3px solid #06b6d455;outline-offset:3px;}

  .category-card{margin-top:10px;padding:10px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.7),rgba(255,255,255,0.35));box-shadow:var(--shadow);border:var(--glass-border);animation:fadein .4s;}
  @keyframes fadein{from{opacity:0;transform:translateY(24px);}to{opacity:1;transform:translateY(0);}}
  .category-card h3{margin:0 0 8px 0}
  .proc-list{display:grid;gap:8px}
  .proc-item{background:rgba(255,255,255,0.92);padding:10px;border-radius:10px;border:1.5px solid rgba(16,185,129,0.10);transition:box-shadow .2s,transform .2s;}
  .proc-item.proc-open{box-shadow:0 12px 32px 0 rgba(16,185,129,0.23);border:1.5px solid #06b6d4;transform:scale(1.02);}
  .proc-head{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
  .proc-title{font-weight:700}
  .pill{padding:6px 8px;border-radius:999px;background:linear-gradient(90deg,#16a34a 60%,#06b6d4 100%);color:#fff;font-weight:700;font-size:0.92rem;border:none;box-shadow:0 1px 8px rgba(16,185,129,0.09);}
  .proc-expand{display:none;margin-top:8px}
  .proc-open .proc-expand{display:block}
  .proc-svg svg{box-shadow:0 4px 24px rgba(6,182,212,.16);border:2px solid #06b6d4;border-radius:14px;background:rgba(255,255,255,0.22);}
  .copy-btn{background:transparent;border:none;font-size:1.1em;cursor:pointer;margin-left:8px;}
  .copy-btn:focus{outline:2px solid #06b6d4;}

  aside.tools{display:grid;gap:10px;padding:12px;border-radius:12px;background:var(--glass);box-shadow:var(--shadow);backdrop-filter:blur(12px);border:var(--glass-border);}
  .tool{padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.7),rgba(255,255,255,0.32));border:var(--glass-border);}
  canvas{width:100%;height:120px;border-radius:8px;box-shadow:0 2px 16px #06b6d444;}

  footer{margin-top:8px;text-align:center;color:var(--muted);font-size:0.85rem;padding-bottom:6px}

  :root[data-theme="dark"] .category-card, :root[data-theme="dark"] .proc-item, :root[data-theme="dark"] .tool, :root[data-theme="dark"] .panel, :root[data-theme="dark"] nav.sidebar { background:rgba(8,24,18,0.7); color:#dff6ea; border-color:#06b6d4; }
  :root[data-theme="dark"] .pill { background:linear-gradient(90deg,#06b6d4 70%,#16a34a 100%); }
  :root[data-theme="dark"] .cat-btn:hover { background:linear-gradient(90deg,#06b6d4 0%,#16a34a 100%); }

  button:focus,input:focus,textarea:focus{outline:3px solid #06b6d4;outline-offset:3px;border-radius:8px}

  ::-webkit-scrollbar {width:8px;background:rgba(16,185,129,0.08);}
  ::-webkit-scrollbar-thumb {background:#06b6d4;border-radius:8px;}

  @media (max-width:600px) {
    .app{max-width:100vw;}
    .shell{grid-template-columns:1fr;}
    nav.sidebar{position:fixed;left:0;top:0;z-index:999;width:90vw;max-width:320px;transform:translateX(-100%);transition:transform .3s;}
    nav.sidebar.show{transform:translateX(0);}
    #menuToggle{position:fixed;left:10px;top:10px;z-index:1000;}
  }
</style>
</head>
<body>
<div class="app" role="application" aria-label="EnfermerÃ­a MAXI Final Full">
  <header class="appbar" role="banner">
    <div class="brand">
      <div class="logo" aria-hidden="true">EN</div>
      <div>
        <h1>EnfermerÃ­a MAXI</h1>
        <p class="small">Final Â· Completo Â· Estilo vidrio verde-cian</p>
      </div>
    </div>
    <div class="tools-right">
      <div id="clock" class="clock" aria-live="polite">--:--</div>
      <button id="themeBtn" class="icon-btn" aria-label="Tema">ðŸŒ“</button>
      <button id="menuToggle" class="icon-btn" aria-label="MenÃº">â˜°</button>
    </div>
  </header>

  <div class="shell" role="main">
    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar" aria-label="CategorÃ­as">
      <div class="cat-grid" role="navigation">
        <button class="cat-btn" data-cat="higiene">Higiene</button>
        <button class="cat-btn" data-cat="curaciones">Curaciones</button>
        <button class="cat-btn" data-cat="farmaco">FarmacologÃ­a</button>
        <button class="cat-btn" data-cat="emergencias">Emergencias</button>
        <button class="cat-btn" data-cat="movilizacion">MovilizaciÃ³n</button>
        <button class="cat-btn" data-cat="nutricion">NutriciÃ³n</button>
        <button class="cat-btn" data-cat="infeccion">Control infecciÃ³n</button>
        <button class="cat-btn full" data-cat="medicamentos">Medicamentos</button>
        <button class="cat-btn full" data-cat="enfermedades">Enfermedades</button>
      </div>
      <div style="margin-top:10px" class="small">Toque una categorÃ­a. Cada botÃ³n abre sub-funciones y procedimientos.</div>
      <div style="margin-top:16px;">
        <button class="btn ghost" id="showFavsBtn">Favoritos â˜…</button>
      </div>
    </nav>

    <!-- Main -->
    <main class="panel" id="mainPanel" aria-live="polite">
      <div class="category-card" style="display:flex;gap:8px;align-items:center">
        <input id="globalSearch" class="input" placeholder="Buscar procedimiento/enfermedad/medicamento..." aria-label="Buscar">
        <button id="searchBtn" class="btn primary">Buscar</button>
        <button id="openAllBtn" class="btn ghost">Todas</button>
      </div>

      <div id="contentArea"></div>

      <section id="diseasePanel" class="category-card" style="display:none">
        <h3>Enfermedad â€” Resumen & Wikipedia</h3>
        <div id="diseaseResults" class="small"></div>
        <div style="margin-top:8px">
          <button id="wikiFetchBtn" class="btn primary">Buscar en Wikipedia</button>
          <div id="wikiOutput" class="small" style="margin-top:8px"></div>
        </div>
      </section>
    </main>

    <!-- Tools -->
    <aside class="tools" id="tools" aria-label="Herramientas">
      <div class="tool" aria-label="Calculadora">
        <strong>Calculadora avanzada</strong>
        <div style="display:grid;gap:6px;margin-top:8px">
          <input id="calc_weight" placeholder="Peso (kg)" type="number">
          <input id="calc_height" placeholder="Altura (cm)" type="number">
          <input id="calc_age" placeholder="Edad" type="number">
          <select id="calc_gender"><option value="male">Hombre</option><option value="female">Mujer</option></select>
          <input id="calc_sbp" placeholder="TA sistÃ³lica (opcional)" type="number">
          <input id="calc_dbp" placeholder="TA diastÃ³lica (opcional)" type="number">
          <button id="calcRun" class="btn primary">Calcular IMC / Dosis / PAM / CalorÃ­as</button>
          <div id="calcOutput" class="small"></div>
        </div>
      </div>

      <div class="tool" aria-label="RCP">
        <strong>RCP interactivo</strong>
        <div style="display:grid;gap:6px;margin-top:8px">
          <div id="rcpState" class="small">Estado: detenido</div>
          <div style="display:flex;gap:6px">
            <button id="rcpStart" class="btn primary">Iniciar</button>
            <button id="rcpStop" class="btn ghost">Detener</button>
          </div>
          <div id="rcpTimer" style="font-weight:700;margin-top:6px">00:00</div>
        </div>
      </div>

      <div class="tool" aria-label="Combinador">
        <strong>Combinador de medicamentos</strong>
        <div style="display:grid;gap:6px;margin-top:8px">
          <input id="medSearchBox" placeholder="Buscar fÃ¡rmaco..." />
          <div style="display:flex;gap:6px">
            <select id="medSelectA" aria-label="Medicamento A"></select>
            <select id="medSelectB" aria-label="Medicamento B"></select>
          </div>
          <button id="medCheckBtn" class="btn primary">Verificar combinaciÃ³n</button>
          <div id="medAlert" class="small" style="margin-top:6px"></div>
          <details style="margin-top:6px"><summary class="small">Lista 'Nunca combinar' (crÃ­ticas)</summary>
            <div id="neverList" style="margin-top:8px;max-height:260px;overflow:auto"></div>
          </details>
        </div>
      </div>

      <div class="tool" aria-label="GrÃ¡fico">
        <strong>GrÃ¡fico signos (demo)</strong>
        <canvas id="vitalCanvas" width="360" height="140"></canvas>
      </div>

      <div class="tool" aria-label="PAE">
        <strong>PAE (guardar local)</strong>
        <div style="display:grid;gap:6px;margin-top:8px">
          <input id="pae_name" placeholder="Paciente">
          <textarea id="pae_diag" placeholder="DiagnÃ³stico de enfermerÃ­a"></textarea>
          <textarea id="pae_plan" placeholder="Plan / intervenciones"></textarea>
          <div style="display:flex;gap:6px">
            <button id="paeSave" class="btn primary">Guardar PAE</button>
            <button id="paeExport" class="btn ghost">Exportar JSON</button>
          </div>
          <div id="paeMsg" class="small"></div>
        </div>
      </div>

    </aside>
  </div>

  <footer><span id="year"></span> Â· EnfermerÃ­a MAXI â€” InformaciÃ³n orientativa. Confirme protocolos oficiales.</footer>
</div>

<!-- --------------------------
     SVG illustrations (hidden in DOM, reused)
     -------------------------- -->
<div id="svgLibrary" style="display:none">
  <!-- SVGs igual que antes, omitidos aquÃ­ por espacio -->
  <!-- ... SVGs ... -->
</div>

<script>
const $ = id => document.getElementById(id);
function now(){ return new Date().toLocaleTimeString(); }
$('clock').textContent = now(); setInterval(()=> $('clock').textContent = now(),1000);
$('year').textContent = new Date().getFullYear();

/* Theme toggle */
(function(){
  const btn = $('themeBtn');
  const t = localStorage.getItem('enf_theme');
  if(t === 'dark') document.documentElement.setAttribute('data-theme','dark');
  btn.addEventListener('click', ()=>{
    if(document.documentElement.getAttribute('data-theme') === 'dark'){
      document.documentElement.removeAttribute('data-theme');
      localStorage.setItem('enf_theme','light');
    }
    else {
      document.documentElement.setAttribute('data-theme','dark');
      localStorage.setItem('enf_theme','dark');
    }
  });
})();

/* Responsive menu toggle (mobile) */
(function(){
  const menu = $('menuToggle'), sidebar = document.querySelector('nav.sidebar');
  menu.addEventListener('click', ()=> {
    if(window.innerWidth < 980){
      sidebar.classList.toggle('show');
    } else {
      sidebar.classList.remove('show');
    }
  });
})();

/* Favoritos simple */
const FAV_KEY = 'enf_maxi_favs';
function toggleFav(id) {
  let favs = JSON.parse(localStorage.getItem(FAV_KEY)||'[]');
  if(favs.includes(id)) favs = favs.filter(f=>f!==id);
  else favs.push(id);
  localStorage.setItem(FAV_KEY, JSON.stringify(favs));
  renderFavIcon(id);
}
function renderFavIcon(id) {
  const icon = document.querySelector(`[data-favid="${id}"]`);
  let favs = JSON.parse(localStorage.getItem(FAV_KEY)||'[]');
  if(icon) icon.textContent = favs.includes(id) ? 'â˜…' : 'â˜†';
}
function showFavorites(){
  clearContent();
  let favs = JSON.parse(localStorage.getItem(FAV_KEY)||'[]');
  if(!favs.length){
    contentArea.innerHTML = '<div class="category-card"><strong>No hay favoritos aÃºn.</strong></div>';
    return;
  }
  let favData = [];
  Object.keys(PROCEDURES).forEach(cat=>{
    PROCEDURES[cat].forEach(p=>{
      if(favs.includes(p.id)) favData.push({cat,p});
    });
  });
  const wrapper = document.createElement('div');
  wrapper.className='category-card';
  wrapper.innerHTML = `<h3>Favoritos (${favData.length})</h3>`;
  const listEl = document.createElement('div'); listEl.className='proc-list';
  favData.forEach(r=>{
    const item = document.createElement('div'); item.className='proc-item';
    const svgMap = {
      'lavado_manos':'svg_wash','rcp':'svg_rcp','curacion_escaras':'svg_wound',
      'cuidado_sonda_vesical':'svg_foley','oxigenoterapia':'svg_oxygen','transferencia':'svg_transfer'
    };
    const svgId = svgMap[r.p.id] || null;
    item.innerHTML =
      `<div class="proc-head">
        <div>
          <div class="proc-title">${r.p.title}</div>
          <div class="small">${r.p.summary || ''}</div>
        </div>
        <div style="text-align:right">
          <div class="pill">${r.cat}</div>
          <button class="fav-btn" data-favid="${r.p.id}" title="Favorito">â˜†</button>
          <button class="copy-btn" title="Copiar procedimiento">ðŸ“‹</button>
        </div>
      </div>
      <div class="proc-expand" aria-hidden="true">
        <div><strong>Materiales:</strong> ${(r.p.materials||[]).join(', ')}</div>
        <div style="margin-top:6px"><strong>Pasos:</strong><ol>${(r.p.steps||[]).map(s=>`<li>${s}</li>`).join('')}</ol></div>
        <div style="margin-top:6px"><strong>Notas:</strong> ${r.p.notes||'â€”'}</div>
        ${svgId ? `<div class="proc-svg">${document.getElementById(svgId).outerHTML}</div>` : ''}
      </div>`;
    item.querySelector('.fav-btn').addEventListener('click', ()=>toggleFav(r.p.id));
    renderFavIcon(r.p.id);
    item.querySelector('.copy-btn').addEventListener('click', ()=>{
      navigator.clipboard.writeText(`${r.p.title}: ${(r.p.steps||[]).join(', ')}`);
    });
    item.querySelector('.proc-head').addEventListener('click', ()=> {
      const expanded = item.classList.toggle('proc-open');
      item.querySelector('.proc-expand').setAttribute('aria-hidden', !expanded);
      if(expanded) setTimeout(()=> item.scrollIntoView({behavior:'smooth', block:'center'}),120);
    });
    listEl.appendChild(item);
  });
  wrapper.appendChild(listEl);
  contentArea.appendChild(wrapper);
}
$('showFavsBtn').addEventListener('click', showFavorites);

/* =========================
   Data: procedures (igual que antes, omitido aquÃ­ por brevedad)
   ========================= */
const PROCEDURES = {/* ... igual que antes ... */};
const DISEASES = [/* ... igual que antes ... */];
const NEVER_COMBINE = [/* ... igual que antes ... */];
const MEDS = [/* ... igual que antes ... */];

/* =========================
   Render UI helpers (modificado para fav/copy)
   ========================= */
const contentArea = $('contentArea');
function clearContent(){ contentArea.innerHTML = ''; $('diseasePanel').style.display='none'; }

function renderCategory(cat){
  clearContent();
  const items = PROCEDURES[cat] || [];
  const wrapper = document.createElement('div'); wrapper.className='category-card';
  wrapper.innerHTML = `<h3 style="text-transform:capitalize">${cat}</h3>`;
  const listEl = document.createElement('div'); listEl.className='proc-list';
  items.forEach(p=>{
    const item = document.createElement('div'); item.className='proc-item';
    // attach svg if matching id
    const svgMap = {
      'lavado_manos':'svg_wash','rcp':'svg_rcp','curacion_escaras':'svg_wound',
      'cuidado_sonda_vesical':'svg_foley','oxigenoterapia':'svg_oxygen','transferencia':'svg_transfer'
    };
    const svgId = svgMap[p.id] || null;
    item.innerHTML = `
      <div class="proc-head">
        <div>
          <div class="proc-title">${p.title}</div>
          <div class="small">${p.summary || ''}</div>
        </div>
        <div style="text-align:right">
          <div class="pill">${cat}</div>
          <button class="fav-btn" data-favid="${p.id}" title="Favorito">â˜†</button>
          <button class="copy-btn" title="Copiar procedimiento">ðŸ“‹</button>
          <button class="btn ghost openBtn">Abrir</button>
          ${p.id === 'rcp' ? '<button class="btn primary rcpBtn" style="margin-left:6px">Ir a RCP</button>' : ''}
        </div>
      </div>
      <div class="proc-expand" aria-hidden="true">
        <div><strong>Materiales:</strong> ${(p.materials||[]).join(', ')}</div>
        <div style="margin-top:6px"><strong>Pasos:</strong><ol>${(p.steps||[]).map(s=>`<li>${s}</li>`).join('')}</ol></div>
        <div style="margin-top:6px"><strong>Notas:</strong> ${p.notes||'â€”'}</div>
        ${svgId ? `<div class="proc-svg">${document.getElementById(svgId).outerHTML}</div>` : ''}
      </div>
    `;
    // fav + copy
    item.querySelector('.fav-btn').addEventListener('click', ()=>toggleFav(p.id));
    renderFavIcon(p.id);
    item.querySelector('.copy-btn').addEventListener('click', ()=>{
      navigator.clipboard.writeText(`${p.title}: ${(p.steps||[]).join(', ')}`);
    });
    // event open
    item.querySelector('.openBtn').addEventListener('click', ()=>{
      const expanded = item.classList.toggle('proc-open');
      item.querySelector('.proc-expand').setAttribute('aria-hidden', !expanded);
      if(expanded) setTimeout(()=> item.scrollIntoView({behavior:'smooth', block:'center'}),120);
    });
    // rcp quick
    const rcpBtn = item.querySelector('.rcpBtn');
    if(rcpBtn) rcpBtn.addEventListener('click', ()=> { startRCP(); window.scrollTo({top:0,behavior:'smooth'}); $('rcpTimer').scrollIntoView({behavior:'smooth'}); });
    listEl.appendChild(item);
  });
  wrapper.appendChild(listEl);
  contentArea.appendChild(wrapper);
}

/* Hook sidebar buttons */
document.querySelectorAll('.cat-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const cat = btn.getAttribute('data-cat');
    if(cat === 'medicamentos'){ $('medSearchBox').focus(); return; }
    if(cat === 'enfermedades'){ $('diseasePanel').style.display=''; $('diseaseResults').innerHTML = DISEASES.map(d=>`<div style="margin-bottom:8px"><strong>${d.name}</strong><div class="small">${d.summary}</div></div>`).join(''); return; }
    renderCategory(cat);
  });
});

/* open all */
$('openAllBtn').addEventListener('click', ()=>{
  clearContent();
  Object.keys(PROCEDURES).forEach(k => renderCategory(k));
});

/* Global search (procedures + diseases + meds) */
$('searchBtn').addEventListener('click', ()=>{
  const q = $('globalSearch').value.trim().toLowerCase();
  if(!q){ alert('Ingrese tÃ©rmino de bÃºsqueda'); return; }
  clearContent();
  const results = [];
  Object.keys(PROCEDURES).forEach(cat=>{
    PROCEDURES[cat].forEach(p=>{
      const hay = (p.title + ' ' + p.summary + ' ' + (p.steps||[]).join(' ')).toLowerCase();
      if(hay.includes(q)) results.push({cat,p});
    });
  });
  const card = document.createElement('div'); card.className='category-card';
  card.innerHTML = `<h3>Resultados: "${q}" (${results.length})</h3>`;
  if(results.length){
    const listEl = document.createElement('div'); listEl.className='proc-list';
    results.forEach(r=>{
      const it = document.createElement('div'); it.className='proc-item';
      it.innerHTML = `<div class="proc-head"><div><div class="proc-title">${r.p.title}</div><div class="small">${r.p.summary}</div></div><div class="pill">${r.cat}</div>
        <button class="fav-btn" data-favid="${r.p.id}" title="Favorito">â˜†</button>
        <button class="copy-btn" title="Copiar procedimiento">ðŸ“‹</button>
        </div>
        <div class="proc-expand"><strong>Pasos:</strong><ol>${(r.p.steps||[]).map(s=>`<li>${s}</li>`).join('')}</ol></div>`;
      it.querySelector('.fav-btn').addEventListener('click', ()=>toggleFav(r.p.id));
      renderFavIcon(r.p.id);
      it.querySelector('.copy-btn').addEventListener('click', ()=>{
        navigator.clipboard.writeText(`${r.p.title}: ${(r.p.steps||[]).join(', ')}`);
      });
      it.querySelector('.proc-head').addEventListener('click', ()=> it.classList.toggle('proc-open'));
      listEl.appendChild(it);
    });
    card.appendChild(listEl);
  } else {
    card.innerHTML += `<div class="small">No se encontraron resultados.</div>`;
  }
  // diseases
  const dHits = DISEASES.filter(d => (d.name+' '+d.summary).toLowerCase().includes(q));
  if(dHits.length){ card.innerHTML += `<h4 style="margin-top:8px">Enfermedades</h4>` + dHits.map(d=>`<div class="small"><strong>${d.name}</strong>: ${d.summary}</div>`).join(''); }
  // meds
  const mHits = MEDS.filter(m => m.toLowerCase().includes(q));
  if(mHits.length){ card.innerHTML += `<h4 style="margin-top:8px">Medicamentos</h4><div class="small">${mHits.join(', ')}</div>`; }
  contentArea.appendChild(card);
});

/* Wikipedia search for diseases */
$('wikiFetchBtn').addEventListener('click', async ()=>{
  const q = $('globalSearch').value.trim();
  if(!q){ alert('Escriba tÃ©rmino en la bÃºsqueda (ej: neumonÃ­a)'); return; }
  $('wikiOutput').textContent = 'Buscando en Wikipedia...';
  try{
    const url = `https://es.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(q)}`;
    const res = await fetch(url);
    if(!res.ok){ $('wikiOutput').textContent = 'No encontrado en Wikipedia.'; return; }
    const data = await res.json();
    $('wikiOutput').innerHTML = `<strong>${data.title}</strong><div class="small">${data.extract}</div><div style="margin-top:6px"><a href="${data.content_urls?.desktop?.page||'#'}" target="_blank">Leer en Wikipedia</a></div>`;
    $('diseasePanel').style.display = '';
  }catch(e){ $('wikiOutput').textContent = 'Error al buscar en Wikipedia.'; }
});

/* Populate meds selects and NEVER list */
(function populateMeds(){
  const a = $('medSelectA'), b = $('medSelectB');
  MEDS.forEach(m=>{
    const o = document.createElement('option'); o.value = m; o.textContent = m; a.appendChild(o);
    const p = document.createElement('option'); p.value = m; p.textContent = m; b.appendChild(p);
  });
  // never list
  $('neverList').innerHTML = NEVER_COMBINE.map(n=>`<div style="margin-bottom:8px"><strong>${n.a} + ${n.b}</strong><div class="small">${n.reason} <a href="${n.ref}" target="_blank" rel="noopener">ref</a></div></div>`).join('');
})();

/* med search quick fill */
$('medSearchBox').addEventListener('input', (e)=>{
  const q = e.target.value.trim().toLowerCase();
  if(!q) return;
  const matches = MEDS.filter(m => m.toLowerCase().includes(q));
  if(matches.length){ $('medSelectA').value = matches[0]; $('medSelectB').value = matches[1] || matches[0]; }
});

/* Check med combination */
$('medCheckBtn').addEventListener('click', ()=>{
  const a = $('medSelectA').value.toLowerCase(), b = $('medSelectB').value.toLowerCase();
  const out = $('medAlert');
  if(!a || !b){ out.innerHTML = '<span style="color:var(--danger)">Seleccione dos fÃ¡rmacos</span>'; return; }
  if(a === b){ out.innerHTML = '<span style="color:green">Mismo medicamento seleccionado â€” cuidado con duplicidad terapÃ©utica.</span>'; return; }
  const hits = NEVER_COMBINE.filter(n => (a.includes(n.a) && b.includes(n.b)) || (a.includes(n.b) && b.includes(n.a)));
  if(hits.length){ out.innerHTML = hits.map(h=>`<div style="color:var(--danger)"><strong>Alerta crÃ­tica:</strong> ${h.reason} <a href="${h.ref}" target="_blank">ref</a></div>`).join(''); return; }
  // heuristics
  const warnings = [];
  if((a.includes('warfarin') && b.includes('ibuprofen')) || (b.includes('warfarin') && a.includes('ibuprofen'))) warnings.push('AINE + Warfarina: mayor riesgo de sangrado. Monitorizar INR.');
  if((a.includes('ciprofloxacin') && b.includes('warfarin')) || (b.includes('ciprofloxacin') && a.includes('warfarin'))) warnings.push('Ciprofloxacina puede potenciar efecto anticoagulante.');
  if(warnings.length){ out.innerHTML = warnings.map(w=>`<div style="color:#b45309">${w}</div>`).join(''); return; }
  out.innerHTML = '<span style="color:green">No se detectaron interacciones crÃ­ticas en la base local. Consulte monografÃ­as especializadas para interacciones completas.</span>';
});

/* =========================
   Calculadora avanzada
   ========================= */
$('calcRun').addEventListener('click', ()=>{
  const w = parseFloat($('calc_weight').value), hcm = parseFloat($('calc_height').value), age = parseInt($('calc_age').value) || 30;
  const sbp = parseFloat($('calc_sbp').value), dbp = parseFloat($('calc_dbp').value);
  const gender = $('calc_gender').value;
  const out = $('calcOutput');
  if(!w || !hcm){ out.textContent = 'Ingrese peso y altura.'; return; }
  const h = hcm/100;
  const bmi = +(w/(h*h)).toFixed(1);
  const dosePerKg = 10; // ejemplo guÃ­a
  const doseTotal = +(w * dosePerKg).toFixed(1);
  let map = '';
  if(sbp && dbp) map = Math.round((sbp + 2*dbp)/3);
  // Mifflin St-Jeor
  let bmr = Math.round(10*w + 6.25*hcm - 5*age + (gender==='male'?5:-161));
  const kcal = Math.round(bmr * 1.3);
  out.innerHTML = `<strong>IMC:</strong> ${bmi} kg/mÂ²<br><strong>Dosis estimada (ej):</strong> ${doseTotal} mg (${dosePerKg} mg/kg)<br>${map?'<strong>PAM:</strong> '+map+' mmHg<br>':''}<strong>Requerimiento:</strong> ${kcal} kcal/dÃ­a`;
});

/* =========================
   RCP interactive
   ========================= */
let rcpInterval = null, rcpSeconds = 0;
function startRCP(){
  if(rcpInterval) return;
  rcpSeconds = 0; $('rcpState').textContent = 'Estado: en curso'; $('rcpTimer').textContent='00:00';
  rcpInterval = setInterval(()=>{
    rcpSeconds++;
    const mm = String(Math.floor(rcpSeconds/60)).padStart(2,'0'), ss = String(rcpSeconds%60).padStart(2,'0');
    $('rcpTimer').textContent = `${mm}:${ss}`;
    if(rcpSeconds % 120 === 0){ if(navigator.vibrate) navigator.vibrate(600); alert('Cambio de reanimador recomendado (cada 2 min).'); }
  },1000);
}
function stopRCP(){ if(rcpInterval) clearInterval(rcpInterval); rcpInterval=null; $('rcpState').textContent='Estado: detenido'; $('rcpTimer').textContent='00:00'; }
$('rcpStart').addEventListener('click', startRCP); $('rcpStop').addEventListener('click', stopRCP);

/* =========================
   Vitals canvas (responsive)
   ========================= */
(function initVitals(){
  const canvas = $('vitalCanvas'), ctx = canvas.getContext('2d');
  function resize(){ const rect = canvas.getBoundingClientRect(); const dpr = window.devicePixelRatio || 1; canvas.width = Math.round(rect.width * dpr); canvas.height = Math.round(rect.height * dpr); ctx.setTransform(dpr,0,0,dpr,0,0); draw(); }
  let data = [78,80,76,82,79,81];
  function draw(){ const rect = canvas.getBoundingClientRect(); ctx.clearRect(0,0,rect.width,rect.height); ctx.beginPath(); ctx.strokeStyle = '#16a34a'; ctx.lineWidth=2; data.forEach((v,i)=>{ const x = 10 + (i/(data.length-1))*(rect.width-20); const y = rect.height - ((v-50)/(120-50))*(rect.height-20) - 10; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); ctx.beginPath(); ctx.arc(x,y,2,0,Math.PI*2); ctx.fill(); }); ctx.stroke(); }
  window.addEventListener('resize', resize); resize(); setInterval(()=>{ data.push(70 + Math.round(Math.random()*16)); if(data.length>10) data.shift(); draw(); },4500);
})();

/* =========================
   PAE local save / export
   ========================= */
const PAE_KEY = 'enfermeria_maxi_pae';
$('paeSave').addEventListener('click', ()=>{
  const name = $('pae_name').value.trim(), diag = $('pae_diag').value.trim(), plan = $('pae_plan').value.trim();
  if(!name || !diag){ $('paeMsg').textContent = 'Nombre y diagnÃ³stico requeridos'; setTimeout(()=>$('paeMsg').textContent='',2000); return; }
  const arr = JSON.parse(localStorage.getItem(PAE_KEY) || '[]'); arr.push({name,diag,plan,ts:Date.now()}); localStorage.setItem(PAE_KEY, JSON.stringify(arr));
  $('paeMsg').textContent = 'PAE guardado localmente'; setTimeout(()=>$('paeMsg').textContent='',2000);
});
$('paeExport').addEventListener('click', ()=>{ const data = localStorage.getItem(PAE_KEY) || '[]'; const blob = new Blob([data], { type:'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'pae_export.json'; a.click(); a.remove(); });

/* =========================
   PWA: register service worker & manifest dynamically
   ========================= */
(async function setupPWA(){
  if('serviceWorker' in navigator){
    try{
      // create a simple service worker blob that caches the shell
      const swCode = `
        const CACHE = 'enf-maxi-v1';
        self.addEventListener('install', e => {
          self.skipWaiting();
          e.waitUntil(
            caches.open(CACHE).then(cache => cache.addAll([
              '/',
            ]))
          );
        });
        self.addEventListener('fetch', e => {
          e.respondWith(
            caches.match(e.request).then(r => r || fetch(e.request))
          );
        });
      `;
      const swBlob = new Blob([swCode], { type: 'application/javascript' });
      const swUrl = URL.createObjectURL(swBlob);
      await navigator.serviceWorker.register(swUrl);
      console.log('Service worker registrado (dynamic blob).');
    }catch(err){ console.warn('No se pudo registrar SW:', err); }
  }
  // create manifest dynamically and link
  const manifest = {
    name: 'EnfermerÃ­a MAXI',
    short_name: 'EN-MAXI',
    start_url: '.',
    display: 'standalone',
    background_color: '#eafaf0',
    theme_color: '#16a34a',
    icons: [
      { src: 'data:image/svg+xml;base64,' + btoa(`<svg xmlns="http://www.w3.org/2000/svg" width="192" height="192"><rect width="192" height="192" rx="24" fill="#16a34a"/><text x="96" y="120" font-size="80" text-anchor="middle" fill="#fff" font-family="Roboto">EN</text></svg>`), sizes: '192x192', type: 'image/svg+xml' }
    ]
  };
  const manBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
  const manUrl = URL.createObjectURL(manBlob);
  const link = document.createElement('link'); link.rel = 'manifest'; link.href = manUrl; document.head.appendChild(link);
})();

/* =========================
   Accessibility keyboard support (Enter opens proc)
   ========================= */
document.addEventListener('keydown', function(e){
  if((e.key === 'Enter' || e.key === ' ') && document.activeElement && document.activeElement.closest('.proc-item')){
    const proc = document.activeElement.closest('.proc-item');
    const btn = proc.querySelector('.openBtn');
    if(btn) btn.click();
  }
});

/* Initial default view */
renderCategory('higiene');

</script>
</body>
</html>
