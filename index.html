<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="theme-color" content="#20c997">
  <title>CareTrack Pro ¬∑ Enfermer√≠a (PWA)</title>
  <!-- Bulma CSS para mejor est√©tica -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <!-- Font Awesome para iconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- PWA manifest e iconos, rutas absolutas para GitHub Pages -->
  <link rel="manifest" href="/-Aplicaci-n-Avanzada-de-Enfermer-a-Advanced-Nursing-Application/manifest.webmanifest">
  <link rel="icon" sizes="192x192" href="/-Aplicaci-n-Avanzada-de-Enfermer-a-Advanced-Nursing-Application/assets/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/-Aplicaci-n-Avanzada-de-Enfermer-a-Advanced-Nursing-Application/assets/icons/icon-192.png">
  <meta name="description" content="Registro r√°pido de enfermer√≠a: pacientes, signos vitales, medicaci√≥n, notas, balance h√≠drico y tareas.">
  <style>
    :root{
      --brand:#20c997; /* Verde agua */
      --ink:#111518;
      --muted:#637988;
      --bg:#f6f8fa;
      --card:rgba(255,255,255,0.15); /* transl√∫cido */
      --bord:rgba(255,255,255,0.3);
      --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
      --radius:16px;
      --futuristic-gradient: linear-gradient(135deg, #20c997, #0f766e);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      color:var(--ink);
      background:var(--bg)
    }

    /* üîù Barra superior */
    .topbar{
      position:sticky;top:0;z-index:10;
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;padding:10px 16px;
      background:var(--card);backdrop-filter:blur(10px);
      border-bottom:1px solid var(--bord)
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:40px;height:40px;border-radius:50%;
      background:var(--brand);position:relative;
      box-shadow:0 4px 12px rgba(25,148,230,.3)
    }
    .logo::before{content:"";position:absolute;inset:12px 18px;background:#fff;border-radius:4px}
    .brand-text small{display:block;color:var(--muted);font-size:12px}

    /* üéõ Botones */
    .actions{display:flex;gap:8px;align-items:center}
    .btn{
      appearance:none;border:none;
      background:var(--futuristic-gradient);
      color:#fff;border-radius:8px;
      padding:8px 12px;font-weight:600;
      cursor:pointer;transition:transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      box-shadow:0 4px 8px rgba(0,0,0,0.2);
    }
    .btn:hover{transform:scale(1.05);box-shadow:0 8px 16px rgba(0,0,0,0.3)}
    .btn.primary{background:var(--brand);border-color:transparent;color:#fff}
    .btn.small{padding:4px 8px;border-radius:8px}

    /* Bot√≥n especial para a√±adir valores */
    .btn-add {
      background: var(--ok);
      border: none;
      border-radius: 50%;
      width: 36px; height: 36px;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; color: #fff;
      cursor: pointer;
      transition: transform 0.2s ease-in-out, background 0.2s;
    }
    .btn-add:hover {
      background: #059669; /* verde m√°s oscuro */
      transform: rotate(90deg) scale(1.1);
    }

    /* üì¶ Cards estilo vidrio */
    .card, .box, .notification {
      text-align: center;
      background: var(--card);
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      border-radius: var(--radius);
      border: 1px solid var(--bord);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      padding: 16px;
      margin: 12px 0;
    }

    /* T√≠tulos en cards */
    .card .title, .box .title, .notification .title {
      color: #0f766e;
      font-weight: 600;
      margin-bottom: 12px;
    }

    /* Formularios de entrada */
    .form-container {
      display: none;
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      border: 1px solid rgba(255,255,255,0.2);
    }

    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .form-group {
      flex: 1;
      min-width: 120px;
    }

    .form-group label {
      display: block;
      font-size: 0.8rem;
      color: #0f766e;
      margin-bottom: 5px;
      font-weight: 600;
    }

    .form-group input, .form-group select {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--bord);
      background: rgba(255,255,255,0.2);
      color: var(--ink);
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }

    .btn-action {
      padding: 6px 12px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
    }

    .btn-save {
      background: var(--ok);
      color: white;
    }

    .btn-cancel {
      background: var(--warn);
      color: white;
    }

    /* Alineaci√≥n de tablas */
    .table th, .table td {
      text-align: center;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <section class="hero is-primary">
    <div class="hero-body">
      <p class="title">
        <span class="icon is-large">
          <i class="fas fa-user-nurse fa-2x"></i>
        </span>
        CareTrack Pro
      </p>
      <p class="subtitle">M√≥dulo de Enfermer√≠a Avanzada</p>
    </div>
  </section>
  <div class="container section">
    <div class="columns">
      <!-- Lateral: Paciente y controles -->
      <div class="column is-one-third">
        <div class="card mb-4">
          <div class="card-content">
            <div class="field">
              <label class="label">
                <span class="icon"><i class="fas fa-user-nurse"></i></span>
                Profesional
              </label>
              <input id="nurse-name" class="input" placeholder="Nombre y apellido">
            </div>
            <div class="field">
              <label class="label">
                <span class="icon"><i class="fas fa-hospital-user"></i></span>
                Paciente
              </label>
              <div class="control">
                <select id="patient-select" class="select"></select>
              </div>
            </div>
            <button id="btn-new-patient" class="button is-primary is-fullwidth mb-2">
              <span class="icon"><i class="fas fa-user-plus"></i></span>
              <span>Nuevo paciente</span>
            </button>
            <button id="btn-print" class="button is-light is-fullwidth mb-2">
              <span class="icon"><i class="fas fa-print"></i></span>
              <span>Imprimir</span>
            </button>
            <button id="btn-export" class="button is-link is-fullwidth mb-2">
              <span class="icon"><i class="fas fa-download"></i></span>
              <span>Exportar</span>
            </button>
            <label class="button is-info is-fullwidth filelike">
              <span class="icon"><i class="fas fa-upload"></i></span>
              <span>Importar</span>
              <input id="import-file" type="file" accept="application/json" style="display:none;">
            </label>
            <div class="field mt-2">
              <label class="checkbox">
                <input id="unit-toggle" type="checkbox"> ¬∞C / ¬∞F
              </label>
              <label class="checkbox ml-2">
                <input id="lang-toggle" type="checkbox"> ES / EN
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Principal: M√≥dulos -->
      <div class="column">
        <div class="columns is-multiline">
          <!-- Signos vitales -->
          <div class="column is-half">
            <div class="card mb-4">
              <header class="card-header">
                <p class="card-header-title">
                  <span class="icon"><i class="fas fa-heartbeat"></i></span>
                  Signos Vitales
                </p>
              </header>
              <div class="card-content" id="vitals-wrap">
                <div id="vitals-form" class="form-container">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Temperatura (¬∞C)</label>
                      <input type="number" id="vital-temp" step="0.1" placeholder="36.5">
                    </div>
                    <div class="form-group">
                      <label>FC (lpm)</label>
                      <input type="number" id="vital-hr" placeholder="75">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>PA Sist√≥lica</label>
                      <input type="number" id="vital-sys" placeholder="120">
                    </div>
                    <div class="form-group">
                      <label>PA Diast√≥lica</label>
                      <input type="number" id="vital-dia" placeholder="80">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>SpO‚ÇÇ (%)</label>
                      <input type="number" id="vital-spo2" placeholder="98">
                    </div>
                    <div class="form-group">
                      <label>FR (rpm)</label>
                      <input type="number" id="vital-rr" placeholder="16">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Dolor (0-10)</label>
                      <input type="number" id="vital-pain" min="0" max="10" placeholder="0">
                    </div>
                    <div class="form-group">
                      <label>GCS</label>
                      <input type="number" id="vital-gcs" min="3" max="15" placeholder="15">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Notas</label>
                      <input type="text" id="vital-notes" placeholder="Observaciones">
                    </div>
                  </div>
                  <div class="form-actions">
                    <button id="cancel-vitals" class="btn-action btn-cancel">Cancelar</button>
                    <button id="save-vitals" class="btn-action btn-save">Guardar</button>
                  </div>
                </div>
                <div id="vitals-table"></div>
                <button id="add-vitals" class="button is-primary is-fullwidth add-button">
                  <span class="icon"><i class="fas fa-plus"></i></span>
                  <span>Agregar Signos Vitales</span>
                </button>
              </div>
            </div>
          </div>
          <!-- Medicaci√≥n -->
          <div class="column is-half">
            <div class="card mb-4">
              <header class="card-header">
                <p class="card-header-title">
                  <span class="icon"><i class="fas fa-prescription-bottle-alt"></i></span>
                  Medicamentos
                </p>
              </header>
              <div class="card-content" id="meds-wrap">
                <div id="meds-form" class="form-container">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Medicamento</label>
                      <input type="text" id="med-name" placeholder="Paracetamol">
                    </div>
                    <div class="form-group">
                      <label>Dosis</label>
                      <input type="text" id="med-dose" placeholder="1 g">
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>V√≠a</label>
                      <select id="med-route">
                        <option value="Oral">Oral</option>
                        <option value="Intravenosa">Intravenosa</option>
                        <option value="Intramuscular">Intramuscular</option>
                        <option value="Subcut√°nea">Subcut√°nea</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Frecuencia</label>
                      <select id="med-freq">
                        <option value="c/6h">c/6h</option>
                        <option value="c/8h">c/8h</option>
                        <option value="c/12h">c/12h</option>
                        <option value="c/24h">c/24h</option>
                        <option value="PRN">PRN</option>
                      </select>
                    </div>
                  </div>
                  <div class="form-row">
                    <div class="form-group">
                      <label>Estado</label>
                      <select id="med-status">
                        <option value="Programado">Programado</option>
                        <option value="Administrado">Administrado</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Suspendido">Suspendido</option>
                      </select>
                    </div>
                    <div class="form-group">
                      <label>Hora</label>
                      <input type="time" id="med-time" value="09:00">
                    </div>
                  </div>
                  <div class="form-actions">
                    <button id="cancel-meds" class="btn-action btn-cancel">Cancelar</button>
                    <button id="save-meds" class="btn-action btn-save">Guardar</button>
                  </div>
                </div>
                <div id="meds-table"></div>
                <button id="add-meds" class="button is-primary is-fullwidth add-button">
                  <span class="icon"><i class="fas fa-plus"></i></span>
                  <span>Agregar Medicaci√≥n</span>
                </button>
              </div>
            </div>
          </div>
          <!-- Notas -->
          <div class="column is-half">
            <div class="card mb-4">
              <header class="card-header">
                <p class="card-header-title">
                  <span class="icon"><i class="fas fa-notes-medical"></i></span>
                  Notas de Enfermer√≠a
                </p>
              </header>
              <div class="card-content" id="notes-wrap">
                <div id="notes-form" class="form-container">
                  <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                      <label>Nota</label>
                      <input type="text" id="note-text" placeholder="Descripci√≥n de la nota">
                    </div>
                  </div>
                  <div class="form-actions">
                    <button id="cancel-notes" class="btn-action btn-cancel">Cancelar</button>
                    <button id="save-notes" class="btn-action btn-save">Guardar</button>
                  </div>
                </div>
                <div id="notes-list"></div>
                <button id="add-notes" class="button is-primary is-fullwidth add-button">
                  <span class="icon"><i class="fas fa-plus"></i></span>
                  <span>Agregar Nota</span>
                </button>
              </div>
            </div>
          </div>
          <!-- Balance H√≠drico -->
          <div class="column is-half">
            <div class="card mb-4">
              <header class="card-header">
                <p class="card-header-title">
                  <span class="icon"><i class="fas fa-tint"></i></span>
                  Balance H√≠drico
                </p>
              </header>
              <div class="card-content" id="fluids-wrap">
                <div id="fluids-form" class="form-container">
                  <div class="form-row">
                    <div class="form-group">
                      <label>Ingresos (ml)</label>
                      <input type="number" id="fluid-in" placeholder="500">
                    </div>
                    <div class="form-group">
                      <label>Egresos (ml)</label>
                      <input type="number" id="fluid-out" placeholder="200">
                    </div>
                  </div>
                  <div class="form-actions">
                    <button id="cancel-fluids" class="btn-action btn-cancel">Cancelar</button>
                    <button id="save-fluids" class="btn-action btn-save">Guardar</button>
                  </div>
                </div>
                <div id="fluids-table"></div>
                <button id="add-fluids" class="button is-primary is-fullwidth add-button">
                  <span class="icon"><i class="fas fa-plus"></i></span>
                  <span>Agregar Balance</span>
                </button>
              </div>
            </div>
          </div>
          <!-- Tareas -->
          <div class="column is-half">
            <div class="card mb-4">
              <header class="card-header">
                <p class="card-header-title">
                  <span class="icon"><i class="fas fa-tasks"></i></span>
                  Tareas
                </p>
              </header>
              <div class="card-content" id="tasks-wrap">
                <div id="tasks-form" class="form-container">
                  <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                      <label>Tarea</label>
                      <input type="text" id="task-text" placeholder="Descripci√≥n de la tarea">
                    </div>
                  </div>
                  <div class="form-actions">
                    <button id="cancel-tasks" class="btn-action btn-cancel">Cancelar</button>
                    <button id="save-tasks" class="btn-action btn-save">Guardar</button>
                  </div>
                </div>
                <div id="tasks-list"></div>
                <button id="add-tasks" class="button is-primary is-fullwidth add-button">
                  <span class="icon"><i class="fas fa-plus"></i></span>
                  <span>Agregar Tarea</span>
                </button>
              </div>
            </div>
          </div>
          <!-- Protocolos -->
          <div class="column is-half">
            <div class="card mb-4">
              <header class="card-header">
                <p class="card-header-title">
                  <span class="icon"><i class="fas fa-clipboard-list"></i></span>
                  Protocolos
                </p>
              </header>
              <div class="card-content" id="protocols-wrap">
                <div class="field">
                  <label class="label">Protocolo</label>
                  <div class="control">
                    <div class="select is-fullwidth">
                      <select id="protocol-select">
                        <option value="">Seleccionar protocolo...</option>
                        <option value="rcp">RCP - Reanimaci√≥n Cardiopulmonar</option>
                        <option value="sepsis">Protocolo de Sepsis</option>
                        <option value="avc">ACV - Accidente Cerebrovascular</option>
                        <option value="dolor">Manejo del Dolor</option>
                        <option value="caidas">Prevenci√≥n de Ca√≠das</option>
                        <option value="infecciones">Control de Infecciones</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div id="protocol-content" class="content"></div>
              </div>
            </div>
          </div>
          <!-- Combinaci√≥n de Medicamentos -->
          <div class="column is-half">
            <div class="card mb-4">
              <header class="card-header">
                <p class="card-header-title">
                  <span class="icon"><i class="fas fa-pills"></i></span>
                  Combinaci√≥n de Medicamentos
                </p>
              </header>
              <div class="card-content" id="drug-interactions-wrap">
                <div class="field">
                  <label class="label">Medicamento 1</label>
                  <input id="drug1" class="input" type="text" placeholder="Ej: Paracetamol">
                </div>
                <div class="field">
                  <label class="label">Medicamento 2</label>
                  <input id="drug2" class="input" type="text" placeholder="Ej: Ibuprofeno">
                </div>
                <div class="field">
                  <button id="btn-check-interactions" class="button is-warning is-fullwidth">
                    <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>
                    <span>Verificar Interacciones</span>
                  </button>
                </div>
                <div id="interactions-result" class="content"></div>
              </div>
            </div>
          </div>
          <!-- Calculadora -->
          <div class="column is-half">
            <div class="card mb-4">
              <header class="card-header">
                <p class="card-header-title">
                  <span class="icon"><i class="fas fa-calculator"></i></span>
                  Calculadora M√©dica
                </p>
              </header>
              <div class="card-content" id="calculator-wrap">
                <div class="field">
                  <label class="label">Tipo de C√°lculo</label>
                  <div class="control">
                    <div class="select is-fullwidth">
                      <select id="calc-type">
                        <option value="">Seleccionar c√°lculo...</option>
                        <option value="bmi">IMC - √çndice de Masa Corporal</option>
                        <option value="dosage">C√°lculo de Dosis</option>
                        <option value="iv-flow">Velocidad de Goteo IV</option>
                        <option value="surface-area">√Årea Superficie Corporal</option>
                        <option value="gfr">Filtrado Glomerular</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div id="calc-inputs" class="content"></div>
                <div id="calc-result" class="content"></div>
              </div>
            </div>
          </div>
          <!-- Escuela M√©dica -->
          <div class="column is-half">
            <div class="card mb-4">
              <header class="card-header">
                <p class="card-header-title">
                  <span class="icon"><i class="fas fa-graduation-cap"></i></span>
                  Escuela M√©dica
                </p>
              </header>
              <div class="card-content">
                <div class="field is-grouped">
                  <input id="school-search" class="input" type="text" placeholder="Medicamento, Enfermedad, Tratamiento...">
                  <div class="control">
                    <select id="school-type" class="select">
                      <option value="medicamento">Medicamento</option>
                      <option value="enfermedad">Enfermedad</option>
                      <option value="tratamiento">Tratamiento</option>
                    </select>
                  </div>
                  <button id="btn-school-search" class="button is-link">
                    <span class="icon"><i class="fas fa-search"></i></span>
                    <span>Buscar</span>
                  </button>
                </div>
                <div id="school-results" class="content mt-2"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="content has-text-centered">
      <small>Hecho por David D√≠az ¬∑ CareTrack Pro</small>
    </div>
  </footer>
  
  <script>
    const $ = (s)=>document.querySelector(s);
    const fmtDate = (d)=> new Date(d).toLocaleDateString('es-AR');
    const fmtTime = (d)=> new Date(d).toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'});
    const nowISO = ()=> new Date().toISOString();
    const toF = (c)=> (c*9/5+32).toFixed(1);
    const toC = (f)=> ((f-32)*5/9).toFixed(1);
    const uid = ()=> crypto.randomUUID();

    const DB_KEY = 'ctp_enf_v2';
    const PAGE_SIZE = 5;

    const state = {
      nurse:'',
      unit:'C',
      lang:'es',
      currentPatientId: null,
      patients: {},
      vitals: {},
      meds: {},
      notes: {},
      fluids: {},
      tasks: {},
      protocols: {},
      drugInteractions: {},
      calculations: {},
      pages: { vitals: 1, meds: 1 },
      audit: []
    };

    // -------------- Persistencia --------------
    function saveDB(){ localStorage.setItem(DB_KEY, JSON.stringify(state)); }
    function loadDB(){
      try {
        const raw = localStorage.getItem(DB_KEY);
        if (raw) Object.assign(state, JSON.parse(raw));
      } catch (error) {
        console.error("Error loading data from localStorage:", error);
        resetState();
      }
    }

    function resetState() {
      state.nurse = '';
      state.unit = 'C';
      state.lang = 'es';
      state.currentPatientId = null;
      state.patients = {};
      state.vitals = {};
      state.meds = {};
      state.notes = {};
      state.fluids = {};
      state.tasks = {};
      state.protocols = {};
      state.drugInteractions = {};
      state.calculations = {};
      state.pages = { vitals: 1, meds: 1 };
      state.audit = [];
    }

    function seed(){
      if(Object.keys(state.patients).length) return;
      const p1={id:'P-001',name:'Mar√≠a Gonz√°lez',age:68,condition:'Diabetes tipo 2',allergies:'Penicilina'};
      const p2={id:'P-002',name:'Jos√© P√©rez',age:75,condition:'Hipertensi√≥n',allergies:'Ibuprofeno'};
      state.patients[p1.id]=p1; state.patients[p2.id]=p2;
      state.currentPatientId=p1.id;
      state.vitals[p1.id]=[{id:uid(),at:nowISO(),tempC:36.8,hr:72,sys:120,dia:80,spo2:98,rr:16,pain:0,gcs:15,notes:'Ingreso'}];
      state.meds[p1.id]=[{id:uid(),at:nowISO(),date:nowISO(),time:'09:00',name:'Paracetamol',dose:'1 g',route:'Oral',freq:'c/8h',status:'Programado'}];
      state.notes[p1.id]=[{id:uid(),at:nowISO(),type:'condition',text:'Paciente estable.'}];
      state.fluids[p1.id]=[{id:uid(),at:nowISO(),in:500,out:200}];
      state.tasks[p1.id]=[{id:uid(),text:'Curaci√≥n 18:00',done:false}];
      saveDB();
    }

    // -------------- Pacientes --------------
    function renderPatientSelect(){
      const sel = $('#patient-select'); sel.innerHTML='';
      Object.values(state.patients).forEach(p=>{
        const opt=document.createElement('option');
        opt.value=p.id; opt.textContent=`${p.id} ‚Äì ${p.name}`;
        sel.appendChild(opt);
      });
      if(state.currentPatientId) sel.value=state.currentPatientId;
    }

    // -------------- Signos Vitales --------------
    function renderVitals(){
      const wrap = $('#vitals-table');
      if (!wrap) return;
      const pid = state.currentPatientId;
      const data = state.vitals[pid] || [];
      let html = `<table class="table is-striped is-narrow is-hoverable">
        <thead><tr>
          <th>Fecha</th><th>Temp (${state.unit})</th><th>FC</th><th>PA</th><th>SpO‚ÇÇ</th><th>FR</th>
          <th>Dolor</th><th>GCS</th><th>Notas</th>
        </tr></thead><tbody>`;
      data.slice(-PAGE_SIZE).reverse().forEach(v=>{
        html += `<tr>
          <td>${fmtDate(v.at)} ${fmtTime(v.at)}</td>
          <td>${state.unit==='C' ? v.tempC : toF(v.tempC)}</td>
          <td>${v.hr}</td>
          <td>${v.sys}/${v.dia}</td>
          <td>${v.spo2}</td>
          <td>${v.rr}</td>
          <td>${v.pain}</td>
          <td>${v.gcs}</td>
          <td>${v.notes||''}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }

    // -------------- Medicaci√≥n --------------
    function renderMeds(){
      const wrap = $('#meds-table');
      if (!wrap) return;
      const pid = state.currentPatientId;
      const meds = state.meds[pid] || [];
      let html = `<table class="table is-fullwidth is-hoverable">
        <thead><tr>
          <th>Fecha/Hora</th><th>Medicamento</th><th>Dosis</th><th>V√≠a</th><th>Frecuencia</th><th>Estado</th>
        </tr></thead><tbody>`;
      meds.slice(-PAGE_SIZE).reverse().forEach(m=>{
        html += `<tr>
          <td>${fmtDate(m.at)} ${fmtTime(m.at)}</td>
          <td>${m.name}</td>
          <td>${m.dose}</td>
          <td>${m.route}</td>
          <td>${m.freq}</td>
          <td>${m.status}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }

    // -------------- Notas --------------
    function renderNotes(){
      const wrap = $('#notes-list');
      if (!wrap) return;
      const pid = state.currentPatientId;
      const notes = state.notes[pid] || [];
      let html = '<ul class="notification is-info">';
      notes.slice(-PAGE_SIZE).reverse().forEach(n=>{
        html += `<li><strong>${fmtDate(n.at)}</strong>: ${n.text}</li>`;
      });
      html += '</ul>';
      wrap.innerHTML = html;
    }

    // -------------- Balance H√≠drico --------------
    function renderFluids(){
      const wrap = $('#fluids-table');
      if (!wrap) return;
      const pid = state.currentPatientId;
      const fluids = state.fluids[pid] || [];
      let html = `<table class="table is-fullwidth is-hoverable">
        <thead><tr>
          <th>Fecha/Hora</th><th>Ingresos (ml)</th><th>Egresos (ml)</th>
        </tr></thead><tbody>`;
      fluids.slice(-PAGE_SIZE).reverse().forEach(f=>{
        html += `<tr>
          <td>${fmtDate(f.at)} ${fmtTime(f.at)}</td>
          <td>${f.in}</td>
          <td>${f.out}</td>
        </tr>`;
      });
      html += '</tbody></table>';
      wrap.innerHTML = html;
    }

    // -------------- Tareas --------------
    function renderTasks(){
      const wrap = $('#tasks-list');
      if (!wrap) return;
      const pid = state.currentPatientId;
      const tasks = state.tasks[pid] || [];
      let html = '<ul class="box">';
      tasks.slice(-PAGE_SIZE).reverse().forEach(t=>{
        html += `<li>
          <label class="checkbox">
            <input type="checkbox" ${t.done?'checked':''} data-tid="${t.id}"> ${t.text}
          </label>
        </li>`;
      });
      html += '</ul>';
      wrap.innerHTML = html;
      // Wire up checkboxes
      wrap.querySelectorAll('input[type="checkbox"]').forEach(chk=>{
        chk.addEventListener('change', (e)=>{
          const id = e.target.getAttribute('data-tid');
          const task = tasks.find(t=>t.id===id);
          if(task){
            task.done = e.target.checked;
            saveDB();
            renderTasks();
          }
        });
      });
    }

    // -------------- Protocolos --------------
    const protocolsData = {
      rcp: {
        title: "RCP - Reanimaci√≥n Cardiopulmonar",
        steps: [
          "1. Verificar inconsciencia y ausencia de pulso",
          "2. Activar sistema de emergencias",
          "3. Posici√≥n correcta del paciente",
          "4. Compresiones tor√°cicas: 30 compresiones a 100-120/min",
          "5. V√≠a a√©rea: inclinar cabeza, elevar ment√≥n",
          "6. Ventilaci√≥n: 2 ventilaciones de rescate",
          "7. Continuar ciclos 30:2 hasta llegada de ayuda",
          "8. Si disponible, usar DEA seg√∫n instrucciones"
        ],
        notes: "Profundidad: 5-6 cm, permitir retroceso completo, minimizar interrupciones"
      },
      sepsis: {
        title: "Protocolo de Sepsis",
        steps: [
          "1. Identificar signos de alerta: fiebre, hipotensi√≥n, taquicardia",
          "2. Obtener cultivos (sangre, orina, esputo)",
          "3. Administrar antibi√≥ticos emp√≠ricos en primera hora",
          "4. Reposici√≥n h√≠drica agresiva (30ml/kg)",
          "5. Monitoreo continuo: PA, FC, diuresis",
          "6. Control de lactato s√©rico",
          "7. Considerar vasopresores si hipotensi√≥n persiste",
          "8. Reevaluaci√≥n constante y ajuste de tratamiento"
        ],
        notes: "Tiempo es cr√≠tico: iniciar tratamiento dentro de la primera hora"
      },
      avc: {
        title: "ACV - Accidente Cerebrovascular",
        steps: [
          "1. Escala FAST: Facial droop, Arm weakness, Speech, Time",
          "2. Obtener hora exacta de inicio de s√≠ntomas",
          "3. Signos vitales estables",
          "4. Glicemia capilar inmediata",
          "5. TC de cr√°neo urgente",
          "6. Evaluaci√≥n neurol√≥gica completa (NIHSS)",
          "7. Considerar trombol√≠ticos si <4.5h",
          "8. Monitoreo neurol√≥gico estrecho"
        ],
        notes: "Ventana terap√©utica limitada, actuaci√≥n r√°pida es esencial"
      },
      dolor: {
        title: "Manejo del Dolor",
        steps: [
          "1. Evaluaci√≥n inicial: escala 0-10",
          "2. Caracterizar tipo de dolor (agudo/cr√≥nico)",
          "3. Analgesicos seg√∫n escal√≥n OMS",
          "4. Monitoreo de efectividad cada 30-60 min",
          "5. Evaluar efectos adversos",
          "6. Medidas no farmacol√≥gicas",
          "7. Reevaluaci√≥n continua",
          "8. Documentar respuesta al tratamiento"
        ],
        notes: "El dolor es el 5¬∞ signo vital, evaluaci√≥n continua necesaria"
      },
      caidas: {
        title: "Prevenci√≥n de Ca√≠das",
        steps: [
          "1. Evaluaci√≥n de riesgo (Morse Fall Scale)",
          "2. Identificar factores de riesgo",
          "3. Ambiente seguro: barandas, iluminaci√≥n",
          "4. Calzado antideslizante",
          "5. Acompa√±amiento en deambulaci√≥n",
          "6. Medicamentos: revisar sedantes/hipotensores",
          "7. Educaci√≥n al paciente y familia",
          "8. Reevaluaci√≥n peri√≥dica del riesgo"
        ],
        notes: "Prevenci√≥n es clave, ambiente seguro y evaluaci√≥n continua"
      },
      infecciones: {
        title: "Control de Infecciones",
        steps: [
          "1. Higiene de manos antes y despu√©s de contacto",
          "2. Uso apropiado de EPP",
          "3. Aislamiento seg√∫n tipo de infecci√≥n",
          "4. Limpieza y desinfecci√≥n del ambiente",
          "5. Manejo seguro de material contaminado",
          "6. Educaci√≥n a paciente y visitantes",
          "7. Monitoreo de signos de infecci√≥n",
          "8. Reporte oportuno de casos"
        ],
        notes: "Precauciones est√°ndar siempre, precauciones espec√≠ficas seg√∫n pat√≥geno"
      }
    };

    function renderProtocols() {
      const wrap = $('#protocol-content');
      if (!wrap) return;
      
      const selected = $('#protocol-select').value;
      if (!selected) {
        wrap.innerHTML = '<p class="has-text-grey">Selecciona un protocolo para ver los pasos detallados.</p>';
        return;
      }
      
      const protocol = protocolsData[selected];
      if (!protocol) return;
      
      let html = `<div class="box">
        <h4 class="title is-5">${protocol.title}</h4>
        <div class="content">
          <ol>`;
      
      protocol.steps.forEach(step => {
        html += `<li class="mb-2">${step}</li>`;
      });
      
      html += `</ol>
          <div class="notification is-info is-light">
            <strong>Nota importante:</strong> ${protocol.notes}
          </div>
        </div>
      </div>`;
      
      wrap.innerHTML = html;
    }

    // -------------- Combinaci√≥n de Medicamentos --------------
    const drugInteractionsData = {
      // Common drug interactions database
      'paracetamol-warfarina': {
        severity: 'moderate',
        description: 'El paracetamol puede potenciar el efecto anticoagulante de la warfarina.',
        recommendation: 'Monitorear INR m√°s frecuentemente. Considerar dosis menores de paracetamol.'
      },
      'aspirina-warfarina': {
        severity: 'major',
        description: 'Riesgo significativo de hemorragia por efecto aditivo anticoagulante.',
        recommendation: 'Evitar combinaci√≥n. Si es necesario, monitoreo estricto y ajuste de dosis.'
      },
      'ibuprofeno-warfarina': {
        severity: 'major',
        description: 'Los AINEs aumentan el riesgo de sangrado con anticoagulantes.',
        recommendation: 'Evitar combinaci√≥n. Preferir paracetamol para analgesia.'
      },
      'digoxina-furosemida': {
        severity: 'moderate',
        description: 'La furosemida puede causar hipopotasemia, aumentando toxicidad por digoxina.',
        recommendation: 'Monitorear niveles de potasio y digoxina. Suplementar potasio si necesario.'
      },
      'atenolol-insulina': {
        severity: 'moderate',
        description: 'Los beta-bloqueantes pueden enmascarar s√≠ntomas de hipoglicemia.',
        recommendation: 'Monitoreo gluc√©mico m√°s frecuente. Educar sobre s√≠ntomas at√≠picos.'
      },
      'omeprazol-clopidogrel': {
        severity: 'moderate',
        description: 'El omeprazol puede reducir la efectividad antiagregante del clopidogrel.',
        recommendation: 'Considerar pantoprazol como alternativa al omeprazol.'
      }
    };

    function checkDrugInteractions() {
      const drug1 = $('#drug1').value.toLowerCase().trim();
      const drug2 = $('#drug2').value.toLowerCase().trim();
      const resultDiv = $('#interactions-result');
      
      if (!drug1 || !drug2) {
        resultDiv.innerHTML = '<p class="has-text-danger">Por favor, ingresa ambos medicamentos.</p>';
        return;
      }
      
      if (drug1 === drug2) {
        resultDiv.innerHTML = '<p class="has-text-warning">Has ingresado el mismo medicamento dos veces.</p>';
        return;
      }
      
      // Check for interactions (both directions)
      const key1 = `${drug1}-${drug2}`;
      const key2 = `${drug2}-${drug1}`;
      
      const interaction = drugInteractionsData[key1] || drugInteractionsData[key2];
      
      if (interaction) {
        const severityClass = interaction.severity === 'major' ? 'is-danger' : 
                             interaction.severity === 'moderate' ? 'is-warning' : 'is-info';
        
        resultDiv.innerHTML = `
          <div class="notification ${severityClass}">
            <h5 class="title is-6">
              <span class="icon"><i class="fas fa-exclamation-triangle"></i></span>
              Interacci√≥n ${interaction.severity === 'major' ? 'GRAVE' : 'MODERADA'} detectada
            </h5>
            <p><strong>Descripci√≥n:</strong> ${interaction.description}</p>
            <p><strong>Recomendaci√≥n:</strong> ${interaction.recommendation}</p>
          </div>
        `;
      } else {
        resultDiv.innerHTML = `
          <div class="notification is-success">
            <h5 class="title is-6">
              <span class="icon"><i class="fas fa-check-circle"></i></span>
              No se encontraron interacciones conocidas
            </h5>
            <p>No se encontraron interacciones documentadas entre <strong>${drug1}</strong> y <strong>${drug2}</strong>.</p>
            <p class="is-size-7 mt-2"><em>Nota: Esta base de datos contiene las interacciones m√°s comunes. Siempre consultar fuentes adicionales para medicamentos menos comunes.</em></p>
          </div>
        `;
      }
    }

    // -------------- Calculadora M√©dica --------------
    function renderCalculatorInputs() {
      const calcType = $('#calc-type').value;
      const inputsDiv = $('#calc-inputs');
      const resultDiv = $('#calc-result');
      
      resultDiv.innerHTML = '';
      
      if (!calcType) {
        inputsDiv.innerHTML = '<p class="has-text-grey">Selecciona un tipo de c√°lculo.</p>';
        return;
      }
      
      let html = '';
      
      switch (calcType) {
        case 'bmi':
          html = `
            <div class="field">
              <label class="label">Peso (kg)</label>
              <input id="weight" class="input" type="number" step="0.1" placeholder="70">
            </div>
            <div class="field">
              <label class="label">Altura (cm)</label>
              <input id="height" class="input" type="number" placeholder="170">
            </div>
            <button id="btn-calc-bmi" class="button is-primary">Calcular IMC</button>
          `;
          break;
        case 'dosage':
          html = `
            <div class="field">
              <label class="label">Peso del paciente (kg)</label>
              <input id="patient-weight" class="input" type="number" step="0.1" placeholder="70">
            </div>
            <div class="field">
              <label class="label">Dosis por kg (mg/kg)</label>
              <input id="dose-per-kg" class="input" type="number" step="0.1" placeholder="10">
            </div>
            <div class="field">
              <label class="label">Concentraci√≥n disponible (mg/ml)</label>
              <input id="concentration" class="input" type="number" step="0.1" placeholder="50">
            </div>
            <button id="btn-calc-dosage" class="button is-primary">Calcular Dosis</button>
          `;
          break;
        case 'iv-flow':
          html = `
            <div class="field">
              <label class="label">Volumen total (ml)</label>
              <input id="total-volume" class="input" type="number" placeholder="1000">
            </div>
            <div class="field">
              <label class="label">Tiempo de infusi√≥n (horas)</label>
              <input id="infusion-time" class="input" type="number" step="0.1" placeholder="8">
            </div>
            <div class="field">
              <label class="label">Factor de goteo (gotas/ml)</label>
              <input id="drop-factor" class="input" type="number" placeholder="20">
            </div>
            <button id="btn-calc-iv-flow" class="button is-primary">Calcular Goteo</button>
          `;
          break;
        case 'surface-area':
          html = `
            <div class="field">
              <label class="label">Peso (kg)</label>
              <input id="sa-weight" class="input" type="number" step="0.1" placeholder="70">
            </div>
            <div class="field">
              <label class="label">Altura (cm)</label>
              <input id="sa-height" class="input" type="number" placeholder="170">
            </div>
            <button id="btn-calc-surface-area" class="button is-primary">Calcular ASC</button>
          `;
          break;
        case 'gfr':
          html = `
            <div class="field">
              <label class="label">Creatinina s√©rica (mg/dl)</label>
              <input id="creatinine" class="input" type="number" step="0.01" placeholder="1.2">
            </div>
            <div class="field">
              <label class="label">Edad (a√±os)</label>
              <input id="age" class="input" type="number" placeholder="65">
            </div>
            <div class="field">
              <label class="label">Peso (kg)</label>
              <input id="gfr-weight" class="input" type="number" step="0.1" placeholder="70">
            </div>
            <div class="field">
              <label class="label">Sexo</label>
              <div class="control">
                <label class="radio">
                  <input type="radio" name="gender" value="male" checked> Masculino
                </label>
                <label class="radio">
                  <input type="radio" name="gender" value="female"> Femenino
                </label>
              </div>
            </div>
            <button id="btn-calc-gfr" class="button is-primary">Calcular FG</button>
          `;
          break;
      }
      
      inputsDiv.innerHTML = html;
    }

    function calculateBMI() {
      const weight = parseFloat($('#weight').value);
      const height = parseFloat($('#height').value);
      const resultDiv = $('#calc-result');
      
      if (!weight || !height || weight <= 0 || height <= 0) {
        resultDiv.innerHTML = '<p class="has-text-danger">Por favor, ingresa valores v√°lidos.</p>';
        return;
      }
      
      const heightM = height / 100;
      const bmi = weight / (heightM * heightM);
      
      let category, categoryClass;
      if (bmi < 18.5) {
        category = 'Bajo peso';
        categoryClass = 'is-info';
      } else if (bmi < 25) {
        category = 'Normal';
        categoryClass = 'is-success';
      } else if (bmi < 30) {
        category = 'Sobrepeso';
        categoryClass = 'is-warning';
      } else {
        category = 'Obesidad';
        categoryClass = 'is-danger';
      }
      
      resultDiv.innerHTML = `
        <div class="notification ${categoryClass}">
          <h5 class="title is-6">Resultado IMC</h5>
          <p><strong>IMC:</strong> ${bmi.toFixed(1)} kg/m¬≤</p>
          <p><strong>Categor√≠a:</strong> ${category}</p>
        </div>
      `;
    }

    function calculateDosage() {
      const weight = parseFloat($('#patient-weight').value);
      const dosePerKg = parseFloat($('#dose-per-kg').value);
      const concentration = parseFloat($('#concentration').value);
      const resultDiv = $('#calc-result');
      
      if (!weight || !dosePerKg || !concentration || weight <= 0 || dosePerKg <= 0 || concentration <= 0) {
        resultDiv.innerHTML = '<p class="has-text-danger">Por favor, ingresa valores v√°lidos.</p>';
        return;
      }
      
      const totalDose = weight * dosePerKg;
      const volume = totalDose / concentration;
      
      resultDiv.innerHTML = `
        <div class="notification is-info">
          <h5 class="title is-6">Resultado C√°lculo de Dosis</h5>
          <p><strong>Dosis total:</strong> ${totalDose.toFixed(1)} mg</p>
          <p><strong>Volumen a administrar:</strong> ${volume.toFixed(2)} ml</p>
        </div>
      `;
    }

    function calculateIVFlow() {
      const volume = parseFloat($('#total-volume').value);
      const time = parseFloat($('#infusion-time').value);
      const dropFactor = parseFloat($('#drop-factor').value);
      const resultDiv = $('#calc-result');
      
      if (!volume || !time || !dropFactor || volume <= 0 || time <= 0 || dropFactor <= 0) {
        resultDiv.innerHTML = '<p class="has-text-danger">Por favor, ingresa valores v√°lidos.</p>';
        return;
      }
      
      const mlPerHour = volume / time;
      const mlPerMin = mlPerHour / 60;
      const dropsPerMin = mlPerMin * dropFactor;
      
      resultDiv.innerHTML = `
        <div class="notification is-info">
          <h5 class="title is-6">Resultado Velocidad de Goteo</h5>
          <p><strong>ml/hora:</strong> ${mlPerHour.toFixed(1)} ml/h</p>
          <p><strong>ml/minuto:</strong> ${mlPerMin.toFixed(2)} ml/min</p>
          <p><strong>Gotas/minuto:</strong> ${Math.round(dropsPerMin)} gotas/min</p>
        </div>
      `;
    }

    function calculateSurfaceArea() {
      const weight = parseFloat($('#sa-weight').value);
      const height = parseFloat($('#sa-height').value);
      const resultDiv = $('#calc-result');
      
      if (!weight || !height || weight <= 0 || height <= 0) {
        resultDiv.innerHTML = '<p class="has-text-danger">Por favor, ingresa valores v√°lidos.</p>';
        return;
      }
      
      // F√≥rmula de Mosteller: ‚àö(altura[cm] √ó peso[kg] / 3600)
      const bsa = Math.sqrt((height * weight) / 3600);
      
      resultDiv.innerHTML = `
        <div class="notification is-info">
          <h5 class="title is-6">Resultado √Årea Superficie Corporal</h5>
          <p><strong>ASC:</strong> ${bsa.toFixed(2)} m¬≤</p>
          <p class="is-size-7 mt-2"><em>F√≥rmula de Mosteller utilizada</em></p>
        </div>
      `;
    }

    function calculateGFR() {
      const creatinine = parseFloat($('#creatinine').value);
      const age = parseFloat($('#age').value);
      const weight = parseFloat($('#gfr-weight').value);
      const gender = document.querySelector('input[name="gender"]:checked').value;
      const resultDiv = $('#calc-result');
      
      if (!creatinine || !age || !weight || creatinine <= 0 || age <= 0 || weight <= 0) {
        resultDiv.innerHTML = '<p class="has-text-danger">Por favor, ingresa valores v√°lidos.</p>';
        return;
      }
      
      // F√≥rmula de Cockcroft-Gault
      let gfr = ((140 - age) * weight) / (72 * creatinine);
      if (gender === 'female') {
        gfr *= 0.85;
      }
      
      let interpretation, categoryClass;
      if (gfr >= 90) {
        interpretation = 'Normal o alto';
        categoryClass = 'is-success';
      } else if (gfr >= 60) {
        interpretation = 'Levemente disminuido';
        categoryClass = 'is-info';
      } else if (gfr >= 30) {
        interpretation = 'Moderadamente disminuido';
        categoryClass = 'is-warning';
      } else {
        interpretation = 'Severamente disminuido';
        categoryClass = 'is-danger';
      }
      
      resultDiv.innerHTML = `
        <div class="notification ${categoryClass}">
          <h5 class="title is-6">Resultado Filtrado Glomerular</h5>
          <p><strong>FG estimado:</strong> ${gfr.toFixed(1)} ml/min/1.73m¬≤</p>
          <p><strong>Interpretaci√≥n:</strong> ${interpretation}</p>
          <p class="is-size-7 mt-2"><em>F√≥rmula de Cockcroft-Gault utilizada</em></p>
        </div>
      `;
    }

    // -------------- Escuela M√©dica (Wikipedia) --------------
    async function searchWiki(term) {
      const apiUrl = `https://es.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(term)}`;
      try {
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error("No encontrado en Wikipedia");
        const data = await response.json();
        return {
          title: data.title,
          extract: data.extract,
          url: data.content_urls?.desktop?.page || `https://es.wikipedia.org/wiki/${encodeURIComponent(term)}`,
          image: data.thumbnail?.source || null
        };
      } catch (error) {
        return null;
      }
    }

    function renderSchoolResults(result) {
      const resultsWrap = $('#school-results');
      if (!resultsWrap) return;
      if (result) {
        resultsWrap.innerHTML = `
          <div class="box">
            <strong>${result.title}</strong>
            <p>${result.extract}</p>
            ${result.image ? `<figure class="image is-128x128"><img src="${result.image}" alt="${result.title}"></figure>` : ''}
            <p><a href="${result.url}" target="_blank">Ver m√°s en Wikipedia</a></p>
          </div>
        `;
      } else {
        resultsWrap.innerHTML = '<p class="has-text-danger">No se encontr√≥ informaci√≥n en Wikipedia.</p>';
      }
    }

    // -------------- Formularios para agregar datos --------------
    function setupFormHandlers() {
      // Signos Vitales
      $('#add-vitals').addEventListener('click', () => {
        $('#vitals-form').style.display = 'block';
        $('#vitals-table').style.display = 'none';
        $('#add-vitals').style.display = 'none';
      });

      $('#cancel-vitals').addEventListener('click', () => {
        $('#vitals-form').style.display = 'none';
        $('#vitals-table').style.display = 'block';
        $('#add-vitals').style.display = 'block';
        clearVitalsForm();
      });

      $('#save-vitals').addEventListener('click', () => {
        const pid = state.currentPatientId;
        if (!pid) return;
        
        const vital = {
          id: uid(),
          at: nowISO(),
          tempC: parseFloat($('#vital-temp').value) || 0,
          hr: parseInt($('#vital-hr').value) || 0,
          sys: parseInt($('#vital-sys').value) || 0,
          dia: parseInt($('#vital-dia').value) || 0,
          spo2: parseInt($('#vital-spo2').value) || 0,
          rr: parseInt($('#vital-rr').value) || 0,
          pain: parseInt($('#vital-pain').value) || 0,
          gcs: parseInt($('#vital-gcs').value) || 0,
          notes: $('#vital-notes').value || ''
        };

        if (!state.vitals[pid]) {
          state.vitals[pid] = [];
        }
        state.vitals[pid].push(vital);
        saveDB();
        renderVitals();
        
        $('#vitals-form').style.display = 'none';
        $('#vitals-table').style.display = 'block';
        $('#add-vitals').style.display = 'block';
        clearVitalsForm();
      });

      // Medicamentos
      $('#add-meds').addEventListener('click', () => {
        $('#meds-form').style.display = 'block';
        $('#meds-table').style.display = 'none';
        $('#add-meds').style.display = 'none';
      });

      $('#cancel-meds').addEventListener('click', () => {
        $('#meds-form').style.display = 'none';
        $('#meds-table').style.display = 'block';
        $('#add-meds').style.display = 'block';
        clearMedsForm();
      });

      $('#save-meds').addEventListener('click', () => {
        const pid = state.currentPatientId;
        if (!pid) return;
        
        const med = {
          id: uid(),
          at: nowISO(),
          date: nowISO(),
          time: $('#med-time').value,
          name: $('#med-name').value || '',
          dose: $('#med-dose').value || '',
          route: $('#med-route').value,
          freq: $('#med-freq').value,
          status: $('#med-status').value
        };

        if (!state.meds[pid]) {
          state.meds[pid] = [];
        }
        state.meds[pid].push(med);
        saveDB();
        renderMeds();
        
        $('#meds-form').style.display = 'none';
        $('#meds-table').style.display = 'block';
        $('#add-meds').style.display = 'block';
        clearMedsForm();
      });

      // Notas
      $('#add-notes').addEventListener('click', () => {
        $('#notes-form').style.display = 'block';
        $('#notes-list').style.display = 'none';
        $('#add-notes').style.display = 'none';
      });

      $('#cancel-notes').addEventListener('click', () => {
        $('#notes-form').style.display = 'none';
        $('#notes-list').style.display = 'block';
        $('#add-notes').style.display = 'block';
        clearNotesForm();
      });

      $('#save-notes').addEventListener('click', () => {
        const pid = state.currentPatientId;
        if (!pid) return;
        
        const note = {
          id: uid(),
          at: nowISO(),
          type: 'general',
          text: $('#note-text').value || ''
        };

        if (!state.notes[pid]) {
          state.notes[pid] = [];
        }
        state.notes[pid].push(note);
        saveDB();
        renderNotes();
        
        $('#notes-form').style.display = 'none';
        $('#notes-list').style.display = 'block';
        $('#add-notes').style.display = 'block';
        clearNotesForm();
      });

      // Balance H√≠drico
      $('#add-fluids').addEventListener('click', () => {
        $('#fluids-form').style.display = 'block';
        $('#fluids-table').style.display = 'none';
        $('#add-fluids').style.display = 'none';
      });

      $('#cancel-fluids').addEventListener('click', () => {
        $('#fluids-form').style.display = 'none';
        $('#fluids-table').style.display = 'block';
        $('#add-fluids').style.display = 'block';
        clearFluidsForm();
      });

      $('#save-fluids').addEventListener('click', () => {
        const pid = state.currentPatientId;
        if (!pid) return;
        
        const fluid = {
          id: uid(),
          at: nowISO(),
          in: parseInt($('#fluid-in').value) || 0,
          out: parseInt($('#fluid-out').value) || 0
        };

        if (!state.fluids[pid]) {
          state.fluids[pid] = [];
        }
        state.fluids[pid].push(fluid);
        saveDB();
        renderFluids();
        
        $('#fluids-form').style.display = 'none';
        $('#fluids-table').style.display = 'block';
        $('#add-fluids').style.display = 'block';
        clearFluidsForm();
      });

      // Tareas
      $('#add-tasks').addEventListener('click', () => {
        $('#tasks-form').style.display = 'block';
        $('#tasks-list').style.display = 'none';
        $('#add-tasks').style.display = 'none';
      });

      $('#cancel-tasks').addEventListener('click', () => {
        $('#tasks-form').style.display = 'none';
        $('#tasks-list').style.display = 'block';
        $('#add-tasks').style.display = 'block';
        clearTasksForm();
      });

      $('#save-tasks').addEventListener('click', () => {
        const pid = state.currentPatientId;
        if (!pid) return;
        
        const task = {
          id: uid(),
          text: $('#task-text').value || '',
          done: false
        };

        if (!state.tasks[pid]) {
          state.tasks[pid] = [];
        }
        state.tasks[pid].push(task);
        saveDB();
        renderTasks();
        
        $('#tasks-form').style.display = 'none';
        $('#tasks-list').style.display = 'block';
        $('#add-tasks').style.display = 'block';
        clearTasksForm();
      });
    }

    function clearVitalsForm() {
      $('#vital-temp').value = '';
      $('#vital-hr').value = '';
      $('#vital-sys').value = '';
      $('#vital-dia').value = '';
      $('#vital-spo2').value = '';
      $('#vital-rr').value = '';
      $('#vital-pain').value = '';
      $('#vital-gcs').value = '';
      $('#vital-notes').value = '';
    }

    function clearMedsForm() {
      $('#med-name').value = '';
      $('#med-dose').value = '';
      $('#med-route').value = 'Oral';
      $('#med-freq').value = 'c/8h';
      $('#med-status').value = 'Programado';
      $('#med-time').value = '09:00';
    }

    function clearNotesForm() {
      $('#note-text').value = '';
    }

    function clearFluidsForm() {
      $('#fluid-in').value = '';
      $('#fluid-out').value = '';
    }

    function clearTasksForm() {
      $('#task-text').value = '';
    }

    // -------------- Acciones y Wireup --------------
    function wire(){
      $('#patient-select')?.addEventListener('change', (e)=>{
        state.currentPatientId = e.target.value;
        saveDB();
        renderAll();
      });

      $('#nurse-name')?.addEventListener('change', (e)=>{
        state.nurse = e.target.value;
        saveDB();
      });

      $('#btn-new-patient')?.addEventListener('click', ()=>{
        const name = prompt('Nombre completo del paciente:');
        if (name && name.trim().length > 1) {
          const id = 'P-' + String(Date.now()).slice(-6);
          state.patients[id] = {id, name, age: '', condition: '', allergies: ''};
          state.currentPatientId = id;
          saveDB();
          renderPatientSelect();
          renderAll();
        }
      });

      $('#btn-print')?.addEventListener('click', ()=> window.print());

      $('#btn-export')?.addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'caretrackpro-backup.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      });

      $('#import-file')?.addEventListener('change', (ev)=>{
        const file = ev.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            Object.assign(state, JSON.parse(e.target.result));
            saveDB();
            renderPatientSelect();
            renderAll();
          } catch (error) {
            alert('Archivo inv√°lido');
          }
        };
        reader.readAsText(file);
      });

      $('#unit-toggle')?.addEventListener('change', (e)=>{
        state.unit = e.target.checked ? 'F' : 'C';
        saveDB();
        renderVitals();
      });

      $('#lang-toggle')?.addEventListener('change', (e)=>{
        state.lang = e.target.checked ? 'en' : 'es';
        saveDB();
        // applyLang() function not defined in the original code, so commenting out
        // applyLang();
      });

      $('#btn-school-search')?.addEventListener('click', async () => {
        const query = $('#school-search').value.trim();
        const type = $('#school-type').value;
        const resultsWrap = $('#school-results');
        resultsWrap.innerHTML = '<p>Buscando...</p>';

        if (!query) {
          resultsWrap.innerHTML = '<p class="has-text-danger">Ingresa un t√©rmino de b√∫squeda.</p>';
          return;
        }
        const result = await searchWiki(query);
        renderSchoolResults(result);
      });

      // Event listeners for new modules
      $('#protocol-select')?.addEventListener('change', renderProtocols);
      
      $('#btn-check-interactions')?.addEventListener('click', checkDrugInteractions);
      
      $('#calc-type')?.addEventListener('change', renderCalculatorInputs);
      
      // Calculator button event listeners will be added dynamically
      document.addEventListener('click', (e) => {
        if (e.target.id === 'btn-calc-bmi') calculateBMI();
        if (e.target.id === 'btn-calc-dosage') calculateDosage();
        if (e.target.id === 'btn-calc-iv-flow') calculateIVFlow();
        if (e.target.id === 'btn-calc-surface-area') calculateSurfaceArea();
        if (e.target.id === 'btn-calc-gfr') calculateGFR();
      });

      // Setup form handlers
      setupFormHandlers();
    }

    function renderAll() {
      renderVitals();
      renderMeds();
      renderNotes();
      renderFluids();
      renderTasks();
      renderProtocols();
      renderCalculatorInputs();
    }

    // Initialize the app
    loadDB();
    seed();
    renderPatientSelect();
    renderAll();
    wire();
  </script>
</body>
</html>
