<!-- Guarda como caretrack-pro-extended.html -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="CareTrack Pro · Avanzado: PAE, protocolos farmacológicos, buscador de prospectos y precios (usa proxy server para precios)" />
  <meta name="theme-color" content="#0b66ff">
  <link rel="manifest" href="manifest.json">
  <title>CareTrack Pro · Avanzado (PWA)</title>

  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    /* (Estilos principales: iguales a ejemplo anterior, compactados para brevedad) */
    :root{--bg:#f6fafc;--surface:#fff;--muted:#6b7280;--primary:#0b66ff;--accent:#10b981;--danger:#ef4444;--radius:12px;--shadow:0 8px 24px rgba(2,6,23,0.06);--font:'Roboto',system-ui;}
    :root[data-theme="dark"]{--bg:#071024;--surface:#0f1724;--muted:#9ca3af;--primary:#4ea6ff;--accent:#34d399;}
    *{box-sizing:border-box} body{margin:0;font-family:var(--font);background:linear-gradient(180deg,var(--bg),#eaf4ff);color:#0f1724;padding:1rem;}
    header{display:flex;justify-content:space-between;align-items:center;padding:0.6rem;border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.7), rgba(255,255,255,0.4));box-shadow:var(--shadow);backdrop-filter:blur(6px)}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));display:grid;place-items:center;color:#fff;font-weight:700}
    .container{max-width:1300px;margin:1rem auto;display:grid;grid-template-columns:280px 1fr 360px;gap:1rem}
    nav.sidebar, main.panel, aside.tools{background:var(--surface);padding:1rem;border-radius:12px;box-shadow:var(--shadow)}
    .card{padding:0.6rem;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.35))}
    .small{font-size:0.9rem;color:var(--muted)}
    .btn{padding:0.5rem 0.7rem;border-radius:8px;border:0;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--primary),#3b82f6);color:#fff}
    input,select,textarea{padding:0.5rem;border-radius:8px;border:1px solid rgba(0,0,0,0.06);width:100%}
    table{width:100%;border-collapse:collapse} td,th{padding:6px;border-bottom:1px solid rgba(0,0,0,0.04)}
    footer{grid-column:1/-1;text-align:center;color:var(--muted);margin-top:0.6rem}
  </style>
</head>
<body>
  <header role="banner" aria-label="CareTrack Pro avanzado">
    <div style="display:flex;align-items:center;gap:0.8rem">
      <div class="logo" aria-hidden="true">CT</div>
      <div>
        <h1>CareTrack Pro · Avanzado</h1>
        <div class="small">PAE · Protocolos farmacológicos · Precios desde proxy</div>
      </div>
    </div>
    <div style="display:flex;gap:0.6rem;align-items:center">
      <div id="clock" style="font-weight:700;min-width:110px;text-align:center">--:--:--</div>
      <button id="themeToggle" class="btn" aria-pressed="false">Tema</button>
      <button id="syncPrices" class="btn">Sincronizar precios</button>
    </div>
  </header>

  <div class="container" role="application">
    <nav class="sidebar" aria-label="Protocolos">
      <h2>Protocolos farmacológicos</h2>
      <p class="small">Editable — contiene dosificación, indicaciones y contraindicaciones.</p>
      <div id="protocolList" style="display:flex;flex-direction:column;gap:0.5rem"></div>

      <hr style="opacity:0.06;margin:0.8rem 0">

      <div class="card">
        <strong>Agregar / Editar protocolo</strong>
        <input id="protoTitle" placeholder="Nombre del protocolo">
        <input id="protoDose" placeholder="Dosis ejemplo: 500 mg c/8h">
        <textarea id="protoBody" rows="4" placeholder="Indicaciones y contraindicaciones"></textarea>
        <div style="display:flex;gap:0.5rem;margin-top:0.5rem">
          <button id="addProto" class="btn primary">Agregar</button>
          <button id="exportProto" class="btn">Exportar</button>
        </div>
      </div>
    </nav>

    <main class="panel" aria-label="PAE y búsquedas">
      <section>
        <h2>PAE (Proceso de Atención de Enfermería)</h2>
        <!-- Reutilizamos PAE similar a la versión anterior -->
        <div class="card">
          <form id="paeForm" onsubmit="return false" style="display:grid;gap:0.5rem">
            <input id="paeName" placeholder="Paciente (nombre)">
            <div style="display:flex;gap:0.5rem">
              <input id="paeAge" placeholder="Edad (años)" type="number">
              <input id="paeAllergies" placeholder="Alergias">
            </div>
            <textarea id="paeDiagnosis" rows="2" placeholder="Diagnóstico de enfermería"></textarea>
            <textarea id="paePlan" rows="2" placeholder="Planificación"></textarea>
            <textarea id="paeImplement" rows="2" placeholder="Implementación"></textarea>
            <textarea id="paeEval" rows="2" placeholder="Evaluación"></textarea>
            <div style="display:flex;gap:0.5rem">
              <button id="savePae" class="btn primary">Guardar PAE</button>
              <button id="exportPae" class="btn">Exportar</button>
              <div id="paeMsg" class="small" style="margin-left:auto"></div>
            </div>
          </form>
        </div>

        <div style="margin-top:0.8rem" class="card">
          <h3>Buscador prospectos / precios</h3>
          <div style="display:flex;gap:0.5rem">
            <input id="drugQ" placeholder="Buscar por medicamento o principio activo">
            <button id="btnSearchFDA" class="btn">Prospecto (openFDA)</button>
            <button id="btnServerPrices" class="btn">Precios (proxy)</button>
          </div>
          <div id="searchOut" class="small" style="margin-top:0.6rem">Resultados...</div>
        </div>

      </section>

      <section style="margin-top:1rem">
        <h2>Resultados / Prospectos</h2>
        <div id="resultsArea" class="card small">Aquí aparecerán prospectos y precios.</div>
      </section>
    </main>

    <aside class="tools" aria-label="Herramientas">
      <div class="card">
        <strong>IMC</strong>
        <input id="peso" placeholder="Peso (kg)" type="number">
        <input id="altura" placeholder="Altura (cm)" type="number">
        <div style="display:flex;gap:0.5rem;margin-top:0.5rem">
          <button id="calcImc" class="btn primary">Calcular</button>
          <div id="imcOut" class="small" style="margin-left:auto"></div>
        </div>
      </div>

      <div class="card">
        <strong>Mini gráfica</strong>
        <canvas id="miniCanvas" width="300" height="120" style="width:100%;height:120px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)"></canvas>
      </div>

      <div class="card">
        <strong>Export / Import</strong>
        <div style="margin-top:0.4rem" class="small">Exporta protocols y PAE en JSON</div>
        <div style="display:flex;gap:0.5rem;margin-top:0.4rem">
          <button id="exportAll" class="btn">Exportar todo</button>
          <input id="importFile" type="file" accept=".json">
        </div>
      </div>
    </aside>
  </div>

  <footer>© <span id="year"></span> CareTrack Pro · Avanzado — Usa proxy prices en http://localhost:3000</footer>

<script>
/* ---------- Utilities ---------- */
const $ = id => document.getElementById(id);
$('year').textContent = new Date().getFullYear();
(function clock(){ setInterval(()=> $('clock').textContent = new Date().toLocaleTimeString(), 1000); })();

/* ---------- Theme ---------- */
const root = document.documentElement;
$('themeToggle').addEventListener('click', ()=>{
  const isDark = root.getAttribute('data-theme') === 'dark';
  if(isDark) root.removeAttribute('data-theme'); else root.setAttribute('data-theme','dark');
});

/* ---------- Protocols ampliados (ejemplos clínicos) ---------- */
let protocols = [
  {id:'paracetamol', title:'Paracetamol 500 mg', dose:'500 mg VO c/4-6h (max 3 g/día)', indications:'Analgesia y antipirético. Evitar en hepatopatía grave.', contraindications:'Hepatopatía severa; alcoholismo crónico.'},
  {id:'amoxi', title:'Amoxicilina 500 mg', dose:'500 mg VO c/8h', indications:'Infecciones respiratorias sensibles. Ajustar según guía local.', contraindications:'Alergia a penicilinas.'},
  {id:'warfarin', title:'Warfarina', dose:'Variable (según INR)', indications:'Anticoagulación oral. Requiere control periódico de INR.', contraindications:'Sangrado activo, embarazo (evaluar).'}
];

function renderProtocolList(){
  const out = $('protocolList'); out.innerHTML = '';
  protocols.forEach((p,idx)=>{
    const div = document.createElement('div'); div.className='card';
    div.innerHTML = `<strong>${p.title}</strong><div class="small">${p.dose}</div><div class="small" style="margin-top:6px">${p.indications}</div>
      <div style="display:flex;gap:0.5rem;margin-top:6px">
        <button class="btn" data-i="${idx}" onclick="editProto(this)">Editar</button>
        <button class="btn" data-i="${idx}" onclick="delProto(this)">Eliminar</button>
      </div>`;
    out.appendChild(div);
  });
}
window.editProto = function(el){
  const i = +el.dataset.i;
  const p = protocols[i];
  $('protoTitle').value = p.title; $('protoDose').value = p.dose; $('protoBody').value = p.indications + (p.contraindications ? '\nContra: '+p.contraindications : '');
  // delete original on edit (user will re-add)
  protocols.splice(i,1);
  renderProtocolList();
}
window.delProto = function(el){
  const i = +el.dataset.i; protocols.splice(i,1); renderProtocolList();
}
$('addProto').addEventListener('click', ()=>{
  const t = $('protoTitle').value.trim(); if(!t) return alert('Título requerido');
  const d = $('protoDose').value.trim(); const b = $('protoBody').value.trim();
  protocols.push({id:t.toLowerCase().replace(/\s+/g,'_'), title:t, dose:d, indications:b, contraindications:''});
  $('protoTitle').value=''; $('protoDose').value=''; $('protoBody').value='';
  renderProtocolList();
});
$('exportProto').addEventListener('click', ()=> {
  const blob = new Blob([JSON.stringify(protocols,null,2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'protocols.json'; a.click();
});
renderProtocolList();

/* ---------- PAE (guardar local) ---------- */
const paeKey = 'caretrack_pae_v2';
$('savePae').addEventListener('click', ()=>{
  const rec = {
    name: $('paeName').value, age: $('paeAge').value, allergies: $('paeAllergies').value,
    diagnosis: $('paeDiagnosis').value, plan: $('paePlan').value, implement: $('paeImplement').value, eval: $('paeEval').value, ts: Date.now()
  };
  if(!rec.name || !rec.diagnosis) return $('paeMsg').textContent = 'Nombre y diagnóstico requeridos';
  const arr = JSON.parse(localStorage.getItem(paeKey) || '[]'); arr.push(rec); localStorage.setItem(paeKey, JSON.stringify(arr));
  $('paeMsg').textContent = 'PAE guardado localmente'; setTimeout(()=> $('paeMsg').textContent = '', 2000);
});
$('exportPae').addEventListener('click', ()=>{
  const data = localStorage.getItem(paeKey) || '[]'; const blob = new Blob([data],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pae.json'; a.click();
});

/* ---------- IMC ---------- */
$('calcImc').addEventListener('click', ()=>{
  const p = parseFloat($('peso').value), a = parseFloat($('altura').value); if(!p||!a) return $('imcOut').textContent='Ingrese valores';
  const imc = p / ((a/100)*(a/100)); const r = Math.round(imc*10)/10; let cat=''; if(imc<18.5) cat='Bajo peso'; else if(imc<25) cat='Normal'; else if(imc<30) cat='Sobrepeso'; else cat='Obesidad';
  $('imcOut').innerHTML = `IMC: <strong>${r}</strong> — <span>${cat}</span>`;
});

/* ---------- Mini canvas ---------- */
const c = $('miniCanvas'); const ctx = c.getContext('2d');
(function drawMini(){ const data=[72,76,80,78,82,79,77]; ctx.clearRect(0,0,c.width,c.height); ctx.beginPath(); data.forEach((v,i)=>ctx.lineTo((i/(data.length-1))*c.width, c.height - ((v-60)/(100-60))*c.height)); ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--primary')||'#0b66ff'; ctx.lineWidth=2; ctx.stroke(); })();

/* ---------- Prospectos (openFDA) ---------- */
$('btnSearchFDA').addEventListener('click', async ()=>{
  const q = $('drugQ').value.trim(); if(!q) return alert('Ingrese término');
  $('resultsArea').textContent = 'Buscando prospectos (openFDA)...';
  try{
    const api = `https://api.fda.gov/drug/label.json?search=openfda.brand_name:${encodeURIComponent(q)}+OR+openfda.generic_name:${encodeURIComponent(q)}&limit=6`;
    const r = await fetch(api);
    if(!r.ok) throw new Error('No hay resultados en openFDA o limit');
    const data = await r.json();
    if(!data.results || !data.results.length) { $('resultsArea').textContent = 'No hay resultados en openFDA'; return; }
    const html = data.results.map(r=>{
      const title = (r.openfda && (r.openfda.brand_name||r.openfda.generic_name) ? ((r.openfda.brand_name||r.openfda.generic_name).join(', ')) : r.id );
      const man = (r.openfda && r.openfda.manufacturer_name ? r.openfda.manufacturer_name.join(', '): 'N/A');
      return `<div class="card"><strong>${title}</strong><div class="small">Lab: ${man}</div>
        <div style="margin-top:6px"><button class="btn" onclick="viewLabel('${r.id}')">Ver (resumen)</button> <a class="btn" href="#" onclick="window.open('${r.openfda && r.openfda.product_ndc ? 'https://www.accessdata.fda.gov/scripts/cder/daf/index.cfm?ApplNo='+r.openfda.product_ndc[0] : '#'}','_blank')">Más</a></div></div>`;
    }).join('');
    $('resultsArea').innerHTML = html;
    window._openfda = data.results;
  }catch(err){
    $('resultsArea').textContent = 'Error openFDA o sin acceso desde el navegador. Reintente o use proxy.';
    console.error(err);
  }
});
window.viewLabel = function(id){
  const arr = window._openfda || []; const found = arr.find(x=>x.id===id);
  if(!found) return alert('No encontrado');
  const ind = (found.indications_and_usage||['Sin indicaciones']).join('\n\n').slice(0,1200);
  const adv = (found.adverse_reactions||['Sin reacciones']).join('\n\n').slice(0,1200);
  alert(`Indicaciones (resumen):\n${ind}\n\nReacciones (resumen):\n${adv}`);
}

/* ---------- Precios via proxy server (server.js) ---------- */
$('btnServerPrices').addEventListener('click', async ()=>{
  const q = $('drugQ').value.trim(); if(!q) return alert('Ingrese término');
  $('searchOut').textContent = 'Consultando proxy de precios (http://localhost:3000)...';
  try{
    const resp = await fetch(`http://localhost:3000/api/prices?q=${encodeURIComponent(q)}`);
    if(!resp.ok) throw new Error('Proxy no disponible');
    const data = await resp.json();
    if(!data.count) { $('resultsArea').innerHTML = '<div class="small">No se encontraron precios en datasets sincronizados.</div>'; return; }
    // mostrar primeros 20 resultados
    const html = data.data.slice(0,50).map(it=>{
      // mostrar algunas columnas clave (buscamos keys heurísticas)
      const row = it.row;
      const name = row.nombre || row.producto || row['Producto'] || row['Medicamento'] || Object.values(row)[0];
      const price = row.precio || row['Precio'] || row['precio'] || '';
      return `<div class="card"><strong>${name}</strong><div class="small">Fuente: ${it.source} ${price? '· Precio: '+price : ''}</div></div>`;
    }).join('');
    $('resultsArea').innerHTML = html;
  }catch(err){
    $('resultsArea').innerHTML = `<div class="small">No fue posible conectar con proxy de precios. Asegúrate de ejecutar server.js en http://localhost:3000</div>`;
    console.warn(err);
  }
});

/* ---------- Sincronizar (trigger refresh en servidor) ---------- */
$('syncPrices').addEventListener('click', async ()=>{
  try{
    const r = await fetch('http://localhost:3000/api/refresh');
    if(!r.ok) throw new Error('No refresh');
    const json = await r.json();
    alert('Sincronización iniciada en servidor. Ver consola del servidor para detalle.');
  }catch(err){
    alert('No se pudo solicitar sincronización. Asegúrate de ejecutar el servidor Node.js en http://localhost:3000');
    console.warn(err);
  }
});

/* ---------- Export/Import ---------- */
$('exportAll').addEventListener('click', ()=>{
  const payload = { protocols, pae: JSON.parse(localStorage.getItem('caretrack_pae_v2')||'[]'), ts: Date.now() };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'caretrack-full-export.json'; a.click();
});
$('importFile').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = (ev)=>{
    try{
      const data = JSON.parse(ev.target.result);
      if(data.protocols) { protocols = data.protocols; renderProtocolList(); }
      if(data.pae) localStorage.setItem('caretrack_pae_v2', JSON.stringify(data.pae));
      alert('Importación aplicada localmente.');
    }catch(err){ alert('Error importando JSON'); console.error(err); }
  }; r.readAsText(f);
});

/* ---------- Service Worker registration (PWA) ---------- */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js').then(reg=>{
    console.log('Service worker registrado', reg);
  }).catch(err=> console.warn('Service worker failed', err));
}

/* ---------- Initial UI ---------- */
function renderProtocolList(){ /* reuse earlier defined rendering */ }
renderProtocolList = renderProtocolList || function(){ /* placeholder if not defined */ };
renderProtocolList();
</script>
</body>
</html>
