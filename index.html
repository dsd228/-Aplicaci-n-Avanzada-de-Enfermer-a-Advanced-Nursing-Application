<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<meta name="description" content="Enfermería MAXI · versión móvil optimizada — procedimientos, PAE, calculadora, RCP" />
<title>Enfermería MAXI · Móvil</title>

<!-- Roboto -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
  /* -----------------------
     Mobile-first variables
     ----------------------- */
  :root{
    --bg: #f3f7fb;
    --surface: #ffffff;
    --muted: #6b7280;
    --primary: #0b66ff;
    --accent: #10b981;
    --danger: #ef4444;
    --radius: 14px;
    --shadow: 0 8px 20px rgba(2,6,23,0.06);
    --tap-size: 48px; /* target size for touch */
    --font: 'Roboto', system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    --max-width: 980px;
  }
  :root[data-theme="dark"]{
    --bg:#071024;
    --surface:#0f1724;
    --muted:#9ca3af;
    --primary:#4ea6ff;
    --accent:#34d399;
  }

  /* -----------------------
     Base reset & layout
     ----------------------- */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:var(--font);
    background:linear-gradient(180deg,var(--bg), #eaf4ff);
    color:#06202a;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:env(safe-area-inset-top) 12px 24px;
    display:flex;
    justify-content:center;
  }
  .app {
    width:100%;
    max-width:var(--max-width);
  }

  /* Header */
  header.appbar{
    display:flex;align-items:center;justify-content:space-between;gap:8px;
    background:var(--surface);border-radius:12px;padding:10px 12px;box-shadow:var(--shadow);
    position:sticky;top:12px;z-index:40;
  }
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));color:#fff;display:grid;place-items:center;font-weight:700}
  .brand h1{font-size:1rem;margin:0}
  .brand p{margin:0;font-size:0.78rem;color:var(--muted)}

  .controls{display:flex;gap:8px;align-items:center}
  .clock{min-width:86px;text-align:center;font-weight:700;padding:6px 8px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.6),rgba(255,255,255,0.35));font-size:0.95rem}

  .icon-btn{height:var(--tap-size);width:var(--tap-size);display:grid;place-items:center;border-radius:10px;border:0;background:transparent;cursor:pointer}

  /* Layout content */
  .shell{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
  @media(min-width:900px){ .shell{grid-template-columns:300px 1fr 360px} header.appbar{position:static} }

  /* Sidebar (collapsible in mobile) */
  nav.sidebar{
    background:var(--surface);padding:12px;border-radius:12px;box-shadow:var(--shadow);
    position:relative;
  }
  .hamburger{display:flex;gap:8px;align-items:center;cursor:pointer}
  .side-title{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .side-cats{display:flex;flex-direction:column;gap:8px;margin-top:10px}
  .cat-btn{padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;text-align:left;font-weight:600}
  .cat-btn.small{padding:8px;font-size:0.9rem}

  /* Main column */
  main.panel{background:var(--surface);padding:12px;border-radius:12px;box-shadow:var(--shadow)}
  .search-row{display:flex;gap:8px;align-items:center}
  .search-row input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);font-size:0.98rem}
  .btn{padding:10px 12px;border-radius:10px;border:0;font-weight:700;cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--primary),#3b82f6);color:#fff}
  .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}

  /* Procedures list - accordion optimized for touch */
  .procedures{display:grid;gap:10px;margin-top:10px}
  .proc{
    border-radius:12px;padding:10px;background:linear-gradient(180deg,rgba(255,255,255,0.6),rgba(255,255,255,0.35));
    box-shadow:var(--shadow);
  }
  .proc .head{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
  .proc .title{font-weight:700;font-size:1rem}
  .proc .meta{color:var(--muted);font-size:0.9rem;margin-top:6px}
  .proc .expand{margin-top:10px;display:none}
  .proc.expanded .expand{display:block}
  .proc .pill{padding:6px 8px;border-radius:999px;background:rgba(0,0,0,0.04);font-weight:700;font-size:0.85rem}

  /* Tools panel (bottom area) */
  .tools{display:grid;gap:10px;margin-top:8px}
  .tool-card{background:var(--surface);padding:10px;border-radius:12px;box-shadow:var(--shadow)}

  /* Inputs & lists */
  input,select,textarea{font:inherit}
  textarea{min-height:80px;border-radius:10px;padding:8px;border:1px solid rgba(0,0,0,0.06)}

  /* footer */
  footer{margin-top:12px;text-align:center;color:var(--muted);font-size:0.9rem;padding-bottom:30px}

  /* Accessibility focus */
  button:focus,input:focus,textarea:focus{outline:3px solid rgba(11,102,255,0.12);outline-offset:3px;border-radius:8px}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="Enfermería MAXI móvil">
    <header class="appbar" role="banner">
      <div class="brand">
        <div class="logo" aria-hidden="true">CT</div>
        <div>
          <h1>Enfermería MAXI</h1>
          <p class="muted">Procedimientos y PAE — Móvil optimizado</p>
        </div>
      </div>

      <div class="controls">
        <div id="clock" class="clock" aria-live="polite">--:--</div>
        <button id="themeToggle" class="icon-btn" aria-pressed="false" title="Alternar tema" aria-label="Alternar tema">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 3v2M12 19v2M4.2 4.2l1.4 1.4M18.4 18.4l1.4 1.4M1 12h2M21 12h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>

        <button id="openNav" class="icon-btn" aria-label="Abrir menú" title="Menú">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
        </button>
      </div>
    </header>

    <div class="shell" role="main">
      <!-- Sidebar (off-canvas on mobile) -->
      <nav class="sidebar" id="sidebar" aria-label="Categorías de procedimientos">
        <div class="side-title">
          <strong>Categorías</strong>
          <button id="closeNav" class="icon-btn" aria-label="Cerrar menú" title="Cerrar" style="display:none">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M6 6l12 12M6 18L18 6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
          </button>
        </div>

        <div class="side-cats" role="navigation">
          <button class="cat-btn" data-filter="all">Todas</button>
          <button class="cat-btn" data-filter="higiene">Higiene</button>
          <button class="cat-btn" data-filter="curaciones">Curaciones</button>
          <button class="cat-btn" data-filter="farmaco">Farmacología</button>
          <button class="cat-btn" data-filter="emergencias">Emergencias</button>
          <button class="cat-btn" data-filter="movilizacion">Movilización</button>
          <button class="cat-btn" data-filter="nutricion">Nutrición</button>
          <button class="cat-btn" data-filter="infeccion">Control de infección</button>
        </div>

        <div style="margin-top:12px" class="muted small">Consejo: usa la búsqueda para encontrar procedimientos rápidamente.</div>
      </nav>

      <!-- Panel central -->
      <main class="panel" aria-live="polite">
        <!-- Search -->
        <div style="display:flex;gap:8px;align-items:center" class="tool-card">
          <div class="search-row" style="flex:1">
            <input id="procSearch" type="search" placeholder="Buscar procedimiento, e.g. 'lavado de manos'">
            <button id="searchBtn" class="btn primary" aria-label="Buscar">Buscar</button>
          </div>
          <button id="quickRCP" class="btn ghost" title="Ir a RCP">RCP</button>
        </div>

        <!-- Procedures list (accordion) -->
        <section class="procedures" id="proceduresList" aria-label="Lista de procedimientos">
          <!-- We'll populate procedurally from JS for clarity and easier updates -->
        </section>

        <!-- Tools block -->
        <div class="tools" aria-label="Herramientas">
          <div class="tool-card" id="calcCard">
            <strong>Calculadora avanzada</strong>
            <div style="display:grid;gap:8px;margin-top:8px">
              <input id="c_weight" type="number" placeholder="Peso (kg)" inputmode="decimal" />
              <input id="c_height" type="number" placeholder="Altura (cm)" inputmode="decimal" />
              <input id="c_age" type="number" placeholder="Edad (años)" />
              <select id="c_gender"><option value="male">Hombre</option><option value="female">Mujer</option></select>
              <button id="calcBtn" class="btn primary">Calcular IMC / Dosis</button>
              <div id="calcOutput" class="muted small" style="margin-top:6px"></div>
            </div>
          </div>

          <div class="tool-card" id="rcpCard">
            <strong>RCP interactivo</strong>
            <div style="margin-top:8px;display:grid;gap:8px">
              <div id="rcpStatus" class="muted">Estado: detenido</div>
              <div style="display:flex;gap:8px">
                <button id="startRcpBtn" class="btn primary">Iniciar RCP</button>
                <button id="stopRcpBtn" class="btn ghost">Detener</button>
              </div>
              <div id="rcpTimer" style="font-weight:700;margin-top:6px">00:00</div>
              <div class="small muted">Alerta cada 2 minutos para cambiar reanimador</div>
            </div>
          </div>

          <div class="tool-card" id="paeCard">
            <strong>PAE rápido (guardado local)</strong>
            <div style="display:grid;gap:8px;margin-top:8px">
              <input id="pae_name" placeholder="Paciente (nombre)" />
              <input id="pae_age" placeholder="Edad" />
              <textarea id="pae_diag" placeholder="Diagnóstico de enfermería"></textarea>
              <textarea id="pae_plan" placeholder="Planificación / Intervenciones"></textarea>
              <div style="display:flex;gap:8px">
                <button id="paeSave" class="btn primary">Guardar</button>
                <button id="paeExport" class="btn ghost">Exportar</button>
              </div>
              <div id="paeMsg" class="muted small"></div>
            </div>
          </div>

          <div class="tool-card" id="medComboCard">
            <strong>Combinador de medicamentos (básico)</strong>
            <div style="display:grid;gap:8px;margin-top:8px">
              <select id="med1"><option value="">-- Seleccione --</option></select>
              <select id="med2"><option value="">-- Seleccione --</option></select>
              <button id="checkComboBtn" class="btn primary">Verificar</button>
              <div id="comboResult" class="muted small"></div>
            </div>
          </div>

          <div class="tool-card">
            <strong>Gráfico rápido de signos (demo)</strong>
            <canvas id="miniChart" width="360" height="140" style="width:100%;height:120px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)"></canvas>
          </div>
        </div>
      </main>

      <!-- Right column (desktop) -->
      <aside id="rightCol" style="display:none">
        <div class="tool-card">
          <strong>Atajos</strong>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <button id="openPAEList" class="cat-btn small">Ver historial PAE</button>
            <button id="exportAllBtn" class="cat-btn small">Exportar todo (JSON)</button>
          </div>
        </div>
      </aside>
    </div>

    <footer>
      © <span id="year"></span> Enfermería MAXI · Versión móvil — Información orientativa.
    </footer>
  </div>

<script>
/* ======================
   Mobile-optimized JS
   ====================== */

/* Clock */
(function startClock(){
  const el = document.getElementById('clock');
  function tick(){ const d=new Date(); el.textContent = d.toLocaleTimeString(); }
  tick(); setInterval(tick,1000);
})();

/* Theme */
const themeToggle = document.getElementById('themeToggle');
(function initTheme(){
  const t = localStorage.getItem('maxi-theme');
  if(t === 'dark') document.documentElement.setAttribute('data-theme','dark');
})();
themeToggle.addEventListener('click', ()=>{
  const root = document.documentElement;
  const isDark = root.getAttribute('data-theme') === 'dark';
  if(isDark){ root.removeAttribute('data-theme'); localStorage.setItem('maxi-theme','light'); themeToggle.setAttribute('aria-pressed','false'); }
  else { root.setAttribute('data-theme','dark'); localStorage.setItem('maxi-theme','dark'); themeToggle.setAttribute('aria-pressed','true'); }
});

/* Off-canvas nav for mobile */
const openNav = document.getElementById('openNav'), closeNav = document.getElementById('closeNav'), sidebar = document.getElementById('sidebar');
openNav.addEventListener('click', ()=> {
  // Toggle simple show/hide for mobile: we use CSS display change
  if(getComputedStyle(sidebar).position === 'relative'){ // desktop
    sidebar.scrollTop = 0;
    return;
  }
  // overlay-like: scroll to top and toggle absolute positioning
  if(sidebar.style.transform === 'translateX(0px)'){ sidebar.style.transform=''; sidebar.style.transition='transform 220ms'; }
  else { sidebar.style.transform='translateX(0)'; sidebar.style.transition='transform 220ms'; }
});
closeNav && closeNav.addEventListener('click', ()=> { sidebar.style.transform=''; });

/* Category filter buttons */
document.querySelectorAll('.cat-btn').forEach(btn=>{
  btn.addEventListener('click', ()=> {
    const f = btn.getAttribute('data-filter');
    filterProcedures(f);
    // close mobile nav if small screen
    if(window.innerWidth < 900) sidebar.style.transform='';
  });
});

/* Procedure dataset (50+ procedures trimmed for demo) - mobile friendly content */
const PROCEDURES = [
  /* Hygiene */
  {
    id:'lavado_manos',
    title:'Lavado de manos (higiene)',
    category:'higiene',
    summary:'Técnica básica y quirúrgica para control de infecciones.',
    materials:['Agua y jabón', 'Solución alcohólica 70%', 'Toallas desechables'],
    steps:[
      'Retirar joyas y mangas largas.',
      'Mojar manos y aplicar jabón suficiente.',
      'Frotar palmas, dorsos, entre dedos y uñas por ≥20 s.',
      'Enjuagar y secar con toalla descartable o aire.',
      'Aplicar solución alcohólica si procede hasta evaporación.'
    ],
    refs:['https://www.who.int/es/news-room/q-a-detail/hands-hygiene']
  },
  /* Simple wound care */
  {
    id:'curacion_simple',
    title:'Curación de herida simple',
    category:'curaciones',
    summary:'Limpieza y apósito en heridas no complejas.',
    materials:['Guantes', 'Solución salina', 'Gasa', 'Apósito estéril'],
    steps:[
      'Explicar procedimiento al paciente y colocar protección.',
      'Realizar higiene de manos y colocarse guantes.',
      'Retirar apósito previo con técnica limpia; valorar exudado y tejido.',
      'Irrigar con solución salina estéril si indicado y secar con gasa estéril.',
      'Aplicar apósito adecuado y documentar.'
    ],
    refs:[]
  },
  /* Pressure injury */
  {
    id:'curacion_escaras',
    title:'Manejo de escaras (úlceras por presión)',
    category:'curaciones',
    summary:'Evaluar estadio, aliviar presión y curación local.',
    materials:['Apósitos especiales', 'Colchón antiescaras', 'Guantes'],
    steps:[
      'Evaluar y documentar tamaño, exudado y tejido.',
      'Planificar cambios de posición cada 2 horas si encamado.',
      'Aplicar apósito según tipo de lesión y proteger piel perilesional.',
      'Controlar signos de infección y derivar si empeora.'
    ],
    refs:[]
  },
  /* Admin meds */
  {
    id:'admin_medicamentos',
    title:'Administración segura de medicamentos',
    category:'farmaco',
    summary:'Verificación 5 correctos; registro y vigilancia.',
    materials:['Prescripción', 'Hoja de alergias', 'Equipo según vía'],
    steps:[
      'Verificar identidad del paciente (2 identificadores).',
      'Comprobar medicamento, dosis, vía y hora (5 correctos).',
      'Preparar en ambiente limpio y confirmar fecha de caducidad.',
      'Administrar y observar por reacciones adversas. Registrar administración.'
    ],
    refs:['https://www.who.int/medicines']
  },
  /* RCP */
  {
    id:'rcp_basico',
    title:'RCP básico (adulto) — resumen',
    category:'emergencias',
    summary:'Compresiones 30:2 o compresiones continuas según protocolo.',
    materials:['DEA (si disponible)', 'Equipo RCP'],
    steps:[
      'Verificar seguridad de la escena y respuesta del paciente.',
      'Si no responde, pedir ayuda y activar emergencia.',
      'Iniciar compresiones en centro del tórax ~100-120/min (5-6 cm).',
      'Si está entrenado, dar 2 ventilaciones cada 30 compresiones.',
      'Usar DEA cuando esté disponible.'
    ],
    refs:['https://www.heart.org']
  },
  /* Oxygen therapy */
  {
    id:'oxigenoterapia',
    title:'Oxigenoterapia por cánula/máscara',
    category:'farmaco',
    summary:'Administración y monitorización de oxígeno suplementario.',
    materials:['Cánula nasal', 'Mascarilla', 'Oxímetro'],
    steps:[
      'Verificar indicación y flujometría prescrita.',
      'Colocar dispositivo asegurando confort del paciente.',
      'Controlar saturación con oxímetro y ajustar según objetivo.',
      'Documentar y vigilar irritación o sequedad.'
    ],
    refs:[]
  },
  /* Suction */
  {
    id:'succion_secreciones',
    title:'Aspiración de secreciones (básico)',
    category:'procedimientos',
    summary:'Técnica de succión en vías altas (solo personal capacitado).',
    materials:['Equipo de succión', 'Sondas estériles', 'Guantes, protección ocular'],
    steps:[
      'Preparar y verificar equipo, explicar al paciente.',
      'Colocar protección y realizar succión según técnica.',
      'Monitorizar saturación y registrar características de secreciones.'
    ],
    refs:[]
  },
  /* Foley care */
  {
    id:'cuidado_sonda_vesical',
    title:'Cuidado de sonda vesical (Foley) - mantenimiento',
    category:'procedimientos',
    summary:'Mantener sistema cerrado y prevenir ITU.',
    materials:['Guantes', 'Contenedor para orina', 'Fijador de sonda'],
    steps:[
      'Mantener la bolsa por debajo del nivel de la vejiga.',
      'No desconectar el sistema salvo indicación médica.',
      'Vaciar la bolsa con técnica limpia y registrar volumen.',
      'Observar color, olor y signos de infección.'
    ],
    refs:[]
  },
  /* Feeding assistance */
  {
    id:'asistencia_alimentacion',
    title:'Asistencia en la alimentación y disfagia',
    category:'nutricion',
    summary:'Medidas para alimentación segura y evitar aspiración.',
    materials:['Alimentos adaptados', 'Utensilios adecuados'],
    steps:[
      'Valorar riesgo de aspiración y posicionar al paciente en grado adecuado.',
      'Ofrecer pequeñas porciones y supervisar de cerca.',
      'Registrar ingesta y signos de dificultad (tos, cambios de voz).'
    ],
    refs:[]
  },
  /* Prevention falls */
  {
    id:'prevencion_caidas',
    title:'Prevención de caídas',
    category:'movilizacion',
    summary:'Identificación del riesgo y medidas ambientales.',
    materials:['Calzado antideslizante', 'Barandas', 'Iluminación'],
    steps:[
      'Evaluar riesgo con escala institucional.',
      'Colocar medidas de seguridad (barandas, timbre cerca).',
      'Educar paciente/cuidadores y documentar.'
    ],
    refs:[]
  }
  /* --- Puedes añadir aquí muchos más procedimientos (50-60) siguiendo el mismo objeto JS --- */
];

/* Render procedure cards (accordion-friendly) */
const proceduresList = document.getElementById('proceduresList');
function renderProcedures(list){
  proceduresList.innerHTML = '';
  list.forEach(proc=>{
    const el = document.createElement('article');
    el.className = 'proc';
    el.setAttribute('data-id', proc.id);
    el.setAttribute('data-category', proc.category);
    el.innerHTML = `
      <div class="head">
        <div>
          <div class="title">${proc.title}</div>
          <div class="meta">${proc.summary}</div>
        </div>
        <div style="text-align:right">
          <div class="pill">${proc.category}</div>
          <button class="btn" style="margin-top:8px" data-action="toggle">Ver</button>
        </div>
      </div>
      <div class="expand" aria-hidden="true">
        <div style="margin-top:10px"><strong>Materiales</strong><div class="muted small">${proc.materials.join(' · ')}</div></div>
        <div style="margin-top:8px"><strong>Pasos</strong><ol>${proc.steps.map(s=>`<li>${s}</li>`).join('')}</ol></div>
        <div style="margin-top:8px"><strong>Referencias</strong><div class="muted small">${(proc.refs||[]).map(r=>`<div><a href="${r}" target="_blank" rel="noopener">${r}</a></div>`).join('') || '—'}</div></div>
      </div>
    `;
    // toggle
    el.querySelector('[data-action="toggle"]').addEventListener('click', (e)=>{
      const expanded = el.classList.toggle('expanded');
      el.querySelector('.expand').setAttribute('aria-hidden', !expanded);
      e.currentTarget.textContent = expanded ? 'Cerrar' : 'Ver';
      // smooth scroll to element on mobile to keep content in view
      if(expanded) setTimeout(()=> el.scrollIntoView({behavior:'smooth', block:'center'}), 120);
    });
    proceduresList.appendChild(el);
  });
}
renderProcedures(PROCEDURES);

/* Search & filter */
function filterProcedures(filter){
  filter = filter || 'all';
  const cards = document.querySelectorAll('.proc');
  cards.forEach(c=>{
    if(filter === 'all' || c.dataset.category === filter) c.style.display = '';
    else c.style.display = 'none';
  });
}
document.getElementById('searchBtn').addEventListener('click', ()=> {
  const q = document.getElementById('procSearch').value.trim().toLowerCase();
  if(!q) { renderProcedures(PROCEDURES); return; }
  const results = PROCEDURES.filter(p => (p.title + ' ' + p.summary + ' ' + p.steps.join(' ')).toLowerCase().includes(q));
  renderProcedures(results);
});
document.getElementById('procSearch').addEventListener('keydown', (e)=> { if(e.key === 'Enter') document.getElementById('searchBtn').click(); });

/* Quick RCP button scroll */
document.getElementById('quickRCP').addEventListener('click', ()=>{
  const card = Array.from(document.querySelectorAll('.proc')).find(p => p.querySelector('.title').textContent.toLowerCase().includes('rcp'));
  if(card){ card.scrollIntoView({behavior:'smooth', block:'center'}); card.querySelector('[data-action="toggle"]').click(); }
});

/* Calculadora */
document.getElementById('calcBtn').addEventListener('click', ()=>{
  const w = parseFloat(document.getElementById('c_weight').value);
  const hcm = parseFloat(document.getElementById('c_height').value);
  const age = parseInt(document.getElementById('c_age').value);
  const gender = document.getElementById('c_gender').value;
  const out = document.getElementById('calcOutput');
  if(!w || !hcm || !age){ out.textContent = 'Ingrese peso, altura y edad.'; return; }
  const h = hcm/100;
  const bmi = +(w/(h*h)).toFixed(1);
  const dosePerKg = 10; // ejemplo
  const doseTotal = +(w * dosePerKg).toFixed(1);
  // Mifflin St-Jeor
  let bmr = 10*w + 6.25*hcm - 5*age + (gender === 'male' ? 5 : -161);
  bmr = Math.round(bmr);
  const calories = Math.round(bmr * 1.3);
  out.innerHTML = `<strong>IMC:</strong> ${bmi} kg/m² · <strong>Dosis (ej):</strong> ${doseTotal} mg (${dosePerKg} mg/kg) · <strong>Calorías estimadas:</strong> ${calories} kcal/d`;
});

/* RCP interactive - timer & reminders */
let rcpInterval = null;
let rcpSeconds = 0;
const rcpStatus = document.getElementById('rcpStatus');
const rcpTimerEl = document.getElementById('rcpTimer');
document.getElementById('startRcpBtn').addEventListener('click', startRCP);
document.getElementById('stopRcpBtn').addEventListener('click', stopRCP);

function startRCP(){
  if(rcpInterval) return;
  rcpSeconds = 0;
  rcpStatus.textContent = 'Estado: en curso — compresiones 100-120/min';
  rcpTimerEl.textContent = '00:00';
  rcpInterval = setInterval(()=>{
    rcpSeconds++;
    const mm = String(Math.floor(rcpSeconds/60)).padStart(2,'0');
    const ss = String(rcpSeconds%60).padStart(2,'0');
    rcpTimerEl.textContent = `${mm}:${ss}`;
    if(rcpSeconds % 120 === 0){ // cada 2 minutos
      // small vibration if supported (mobile)
      if(navigator.vibrate) navigator.vibrate(600);
      alert('Cambio de reanimador recomendado: mínimo tiempo de interrupción.');
    }
  },1000);
}
function stopRCP(){
  if(rcpInterval){ clearInterval(rcpInterval); rcpInterval = null; }
  rcpStatus.textContent = 'Estado: detenido';
  rcpTimerEl.textContent = '00:00';
}

/* PAE local save/list/export */
const PAE_KEY = 'maxi_mobile_pae';
document.getElementById('paeSave').addEventListener('click', ()=>{
  const name = document.getElementById('pae_name').value.trim();
  const age = document.getElementById('pae_age').value.trim();
  const diag = document.getElementById('pae_diag').value.trim();
  const plan = document.getElementById('pae_plan').value.trim();
  if(!name || !diag){ document.getElementById('paeMsg').textContent = 'Nombre y diagnóstico requeridos'; setTimeout(()=>document.getElementById('paeMsg').textContent='',2000); return; }
  const arr = JSON.parse(localStorage.getItem(PAE_KEY) || '[]');
  arr.push({name,age,diag,plan,ts:Date.now()});
  localStorage.setItem(PAE_KEY, JSON.stringify(arr));
  document.getElementById('paeMsg').textContent = 'PAE guardado localmente';
  setTimeout(()=>document.getElementById('paeMsg').textContent='',2000);
});
document.getElementById('paeExport').addEventListener('click', ()=>{
  const data = localStorage.getItem(PAE_KEY) || '[]';
  const blob = new Blob([data], { type:'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'pae_export.json'; a.click(); a.remove();
});
document.getElementById('openPAEList') && document.getElementById('openPAEList').addEventListener('click', ()=>{
  const arr = JSON.parse(localStorage.getItem(PAE_KEY) || '[]');
  if(!arr.length) return alert('No hay registros PAE guardados.');
  let txt = arr.map(r => `${r.name} (${r.age}) — ${new Date(r.ts).toLocaleString()} \nDx: ${r.diag}\nPlan: ${r.plan}\n---\n`).join('\n');
  // show as alert (simple) or could create modal
  alert(txt.slice(0,4000) + (txt.length>4000 ? '\n\n(Más... exporta para ver todo)' : ''));
});

/* Medication combiner - populate options and check basic rules */
const meds = [
  {code:'warfarin', label:'Warfarina'},
  {code:'ibuprofen', label:'Ibuprofeno (AINE)'},
  {code:'paracetamol', label:'Paracetamol'},
  {code:'ciprofloxacin', label:'Ciprofloxacina'},
  {code:'metformin', label:'Metformina'},
  {code:'sertraline', label:'Sertralina'},
  {code:'omeprazole', label:'Omeprazol'}
];
const sel1 = document.getElementById('med1'), sel2 = document.getElementById('med2');
meds.forEach(m=>{ const o1=document.createElement('option'); o1.value=m.code; o1.textContent=m.label; sel1.appendChild(o1); const o2=document.createElement('option'); o2.value=m.code; o2.textContent=m.label; sel2.appendChild(o2); });
document.getElementById('checkComboBtn').addEventListener('click', ()=>{
  const a = sel1.value, b = sel2.value;
  const res = document.getElementById('comboResult');
  if(!a || !b){ res.textContent = 'Seleccione dos medicamentos.'; return; }
  const alerts = [];
  if((a==='warfarin' && b==='ibuprofen') || (a==='ibuprofen' && b==='warfarin')) alerts.push('Alerta: Warfarina + AINE puede aumentar riesgo de sangrado. Vigilar INR.');
  if((a==='warfarin' && b==='ciprofloxacin') || (a==='ciprofloxacin' && b==='warfarin')) alerts.push('Alerta: Ciprofloxacina puede potenciar efecto anticoagulante.');
  if((a==='metformin' && b==='ciprofloxacin') || (a==='ciprofloxacin' && b==='metformin')) alerts.push('Aviso: Vigilar función renal y estado general.');
  if(!alerts.length) res.innerHTML = '<span style="color:green">No se detectaron alertas básicas.</span>';
  else res.innerHTML = alerts.map(s=>`<div style="color:#b91c1c">${s}</div>`).join('');
});

/* Mini chart (canvas) responsive */
(function initMiniChart(){
  const canvas = document.getElementById('miniChart');
  const ctx = canvas.getContext('2d');

  function resize(){
    // adjust canvas drawing buffer for device pixel ratio
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.round(rect.width * dpr);
    canvas.height = Math.round(rect.height * dpr);
    ctx.scale(dpr, dpr);
    draw();
  }

  let data = [72,75,78,80,76,82,79];
  function draw(){
    const rect = canvas.getBoundingClientRect();
    ctx.clearRect(0,0,rect.width,rect.height);
    // draw line
    ctx.beginPath();
    ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--primary') || '#0b66ff';
    ctx.lineWidth = 2;
    data.forEach((v,i)=>{
      const x = (i/(data.length-1)) * (rect.width-20) + 10;
      const y = rect.height - ((v-60)/(100-60))* (rect.height-20) - 10;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      ctx.fillStyle = '#fff';
      ctx.beginPath(); ctx.arc(x,y,2,0,Math.PI*2); ctx.fill();
    });
    ctx.stroke();
  }

  window.addEventListener('resize', resize);
  resize();
  // simulate updates
  setInterval(()=>{ data.push(Math.round(70 + Math.random()*12)); if(data.length>8) data.shift(); draw(); }, 5000);
})();

/* Export all (PAE + procedimientos minimal) */
document.getElementById('exportAllBtn') && document.getElementById('exportAllBtn').addEventListener('click', ()=>{
  const payload = { pae: JSON.parse(localStorage.getItem(PAE_KEY) || '[]'), procedures: PROCEDURES };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type:'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'enfermeria_maxi_export.json'; a.click(); a.remove();
});

/* Year in footer */
document.getElementById('year').textContent = new Date().getFullYear();

/* Accessibility: keyboard support to expand with Enter/Space */
document.addEventListener('keydown', function(e){
  if(e.key === 'Enter' || e.key === ' '){
    if(document.activeElement && document.activeElement.closest('.proc')){
      const proc = document.activeElement.closest('.proc');
      const btn = proc.querySelector('[data-action="toggle"]');
      if(btn) btn.click();
    }
  }
});

</script>
</body>
</html>
